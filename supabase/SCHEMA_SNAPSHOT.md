# Database Schema Snapshot

**Source of truth for database structure. Regenerated from live database queries.**

**Last Verified:** 2026-02-22 (Staging database)
**Generated By:** REFRESH_SCHEMA.SQL export + automated processing
**Database:** Staging (InPersonMarketplace-Staging)

---

## Change Log

| Date | Migration | Changes |
|------|-----------|---------|
| 2026-02-22 | 20260222_050_fix_notifications_user_id_fk | **FK fix:** Changed `notifications.user_id` FK from `user_profiles(id)` → `auth.users(id)`. Existing rows translated via `user_profiles.user_id`. Orphaned rows deleted. **Function rewrite:** `notify_transaction_status_change()` now resolves buyer auth.uid via `user_profiles` JOIN (since `transactions.buyer_user_id` references `user_profiles.id`). Vendor path unchanged (`vendor_profiles.user_id` is already auth.uid). Includes `NOTIFY pgrst, 'reload schema'`. Applied to Dev, Staging, & Prod. |
| 2026-02-22 | 20260222_049_scan_vendor_activity_validation | **Function update:** `scan_vendor_activity(p_vertical_id TEXT)` now validates `p_vertical_id` against the `verticals` table when non-NULL. Raises exception `'Invalid vertical_id: %. Must be a valid vertical.'` if the value doesn't exist. NULL remains valid (scans all verticals). No schema changes — function logic only. Applied to Dev, Staging, & Prod. |
| 2026-02-22 | 20260222_048_buyer_search_log | **New table:** `buyer_search_log` (anonymous buyer search tracking for geographic intelligence). Columns: id (UUID PK), zip_code (TEXT, nullable), vertical_id (TEXT FK→verticals), results_count (INTEGER NOT NULL DEFAULT 0), search_type (TEXT, CHECK IN markets/vendors), created_at (TIMESTAMPTZ). **3 indexes:** `idx_bsl_vertical_created` (vertical_id, created_at DESC), `idx_bsl_zip_vertical` (zip_code, vertical_id WHERE zip_code IS NOT NULL), `idx_bsl_zero_results` (vertical_id, created_at DESC WHERE results_count = 0). **RLS:** admin SELECT only. Service role writes from API routes. Applied to Dev, Staging, & Prod. |
| 2026-02-22 | 20260222_047_vendor_quality_checks | **New tables:** `vendor_quality_scan_log` (tracks nightly batch runs: status, vendors_scanned, findings_created, findings_by_check JSONB) and `vendor_quality_findings` (individual findings: vendor_profile_id FK, vertical_id FK, check_type, severity, title, message, details JSONB, reference_key, status, batch_id FK, dismissed_at). **3 partial indexes:** `idx_vqf_vendor_active` (vendor+status WHERE active), `idx_vqf_vendor_dismissed` (vendor+check_type+reference_key WHERE dismissed), `idx_vqf_batch` (batch_id). **RLS:** scan_log admin SELECT only; findings vendor SELECT/UPDATE own + admin SELECT all. **5 check types:** schedule_conflict, low_stock_event, price_anomaly, ghost_listing, inventory_velocity. **3 severities:** action_required, heads_up, suggestion. **3 finding statuses:** active, dismissed, superseded. Cron at `0 10 * * *` (4am CT). New notification type: `vendor_quality_alert`. Applied to Dev, Staging, & Prod. |
| 2026-02-21 | 20260221_046_supabase_linter_fixes | **RLS policy merges (9 tables)**: Merged overlapping permissive policies to eliminate linter warnings. knowledge_articles: replaced FOR ALL + FOR SELECT with single SELECT + per-op admin policies. payments: merged buyer+admin SELECT. shopper_feedback: merged user+admin SELECT. vendor_fee_balance/vendor_fee_ledger: merged vendor+admin SELECT. vendor_feedback: merged vendor+admin SELECT. vendor_profiles: dropped redundant admin_select. vendor_verifications: merged vendor+admin UPDATE. zip_codes: replaced FOR ALL + FOR SELECT with single SELECT + per-op admin policies. **Dropped 4 duplicate indexes**: idx_market_box_subscriptions_offering_active, idx_order_items_order_id, idx_orders_buyer_user_id, idx_orders_parent_id. **Added 18 FK indexes** on admin_activity_log, error_reports(4), knowledge_articles, market_box_subscriptions, markets, orders, shopper_feedback, vendor_activity_flags, vendor_activity_settings, vendor_feedback, vendor_location_cache, vendor_referral_credits, vendor_verifications(2), vertical_admins. **Dropped 4 legacy indexes** on transactions/fulfillments tables. Applied to Dev, Staging, & Prod. |
| 2026-02-21 | 20260221_044_vertical_minimum_order | Added `minimum_order_cents` to `verticals.config` JSONB for each vertical: farmers_market=1000 ($10), food_trucks=500 ($5), fire_works=4000 ($40). No schema changes — data-only update to existing JSONB column. Code reads via `getMinimumOrderCents(vertical)` with hardcoded fallbacks. Pending application to all envs. |
| 2026-02-20 | 20260220_043_vendor_payout_unique_constraint | Added partial unique index `idx_vendor_payouts_order_item_unique` on `vendor_payouts(order_item_id) WHERE status NOT IN ('failed', 'cancelled')`. Prevents duplicate successful payouts at DB level (app code already checked, this is the safety net). Applied to Dev, Staging, & Prod. |
| 2026-02-20 | 20260220_042_fix_remaining_security_definer_search_paths | Added `SET search_path = public` to 11 SECURITY DEFINER functions from early migrations (002/003) that were missed by the 20260126_002 fix: `has_role`, `is_admin`, `is_verifier`, `get_user_vendor_ids`, `handle_new_user`, `track_vendor_status_change`, `notify_transaction_status_change`, `get_vertical_config`, `get_vendor_fields`, `get_listing_fields`, `user_owns_vendor`. All public SECURITY DEFINER functions now have search_path set. Applied to Dev, Staging, & Prod. |
| 2026-02-20 | 20260220_041_add_tip_on_platform_fee | Added `tip_on_platform_fee_cents` (INTEGER NOT NULL DEFAULT 0) to `orders`. Tracks portion of tip attributable to buyer platform fee. Vendor tip = tip_amount - tip_on_platform_fee_cents. Applied to Dev, Staging, & Prod. |
| 2026-02-21 | 20260221_040_event_availability_function | Rewrote `get_available_pickup_dates()` with event support: listing_schedules CTE adds event date columns + cutoff logic (FT events use 24h, not 0), matched_dates CTE adds event date range filter + FT events bypass same-day-only, attendance filter requires attendance for events + traditional (not just traditional), past events auto-filtered by `event_end_date >= CURRENT_DATE`. Applied to Staging. |
| 2026-02-21 | 20260221_039_add_event_market_type | Expanded `markets.market_type` CHECK constraint to include `'event'`. Added columns: `event_start_date` (DATE, nullable), `event_end_date` (DATE, nullable), `event_url` (TEXT, nullable). Added CHECK: event dates required when market_type='event', end >= start. Added index `idx_markets_event_dates` (partial, on event markets). Applied to Staging. |
| 2026-02-19 | 20260219_037_market_box_payout_support | Made `vendor_payouts.order_item_id` nullable (was NOT NULL). Added `market_box_pickup_id` (UUID, nullable, FK→market_box_pickups.id). Added CHECK constraint `vendor_payouts_has_reference` (order_item_id IS NOT NULL OR market_box_pickup_id IS NOT NULL). Added index `idx_payouts_market_box_pickup` (partial, WHERE market_box_pickup_id IS NOT NULL). Also fixed 27 missing PRIMARY KEY constraints on Prod (market_box_pickups + 26 other tables). Applied to Dev, Staging, & Prod. |
| 2026-02-19 | 20260219_036_enforce_listing_tier_limits | Added `enforce_listing_tier_limit()` SECURITY DEFINER function + BEFORE INSERT OR UPDATE trigger `enforce_listing_limit_trigger` on `listings`. Only fires when status changes to 'active'. Checks vendor tier via `vendor_profiles`, enforces limits: FM standard=5, premium/featured=15; FT free=4, basic=8, pro=20, boss=45. Drafts unrestricted. Applied to Dev, Staging, & Prod. |
| 2026-02-19 | 20260219_035_add_payout_status_enum_values | Added `skipped_dev` and `pending_stripe_setup` values to `payout_status` enum. These statuses were used in application code but missing from the DB enum. Uses `ADD VALUE IF NOT EXISTS` (non-transactional in PG). Applied to Dev, Staging, & Prod. |
| 2026-02-18 | 20260218_035_market_box_type | Added `box_type` (TEXT, nullable) to `market_box_offerings`. Food truck "Chef Box" category (weekly_dinner, family_kit, mystery_box, meal_prep, office_lunch). FM offerings leave null. FT form requires it client-side + API validates for FT vendors. |
| 2026-02-18 | 20260218_034_vendor_favorites | New `vendor_favorites` table: `id` (UUID PK), `user_id` (UUID FK→auth.users ON DELETE CASCADE), `vendor_profile_id` (UUID FK→vendor_profiles ON DELETE CASCADE), `created_at` (TIMESTAMPTZ). UNIQUE(user_id, vendor_profile_id). Indexes: `idx_vendor_favorites_user`, `idx_vendor_favorites_vendor`. RLS: users SELECT/INSERT/DELETE own rows. No vertical_id needed — vendor_profile_id scopes to vertical via vendor_profiles.vertical_id. Applied to Dev, Staging, & Prod. |
| 2026-02-18 | 20260218_033_add_free_ft_tier | Expanded `vendor_profiles` tier CHECK constraint to include `'free'`. Added `set_ft_default_tier()` trigger function (BEFORE INSERT on vendor_profiles): auto-sets `tier='free'` for new food_trucks vendors whose tier is NULL or 'standard'. Existing FT vendors (already 'basic' from migration 027) unaffected. |
| 2026-02-18 | 20260218_032_ft_vendor_attendance_hours | Added `vendor_start_time` (TIME, nullable) and `vendor_end_time` (TIME, nullable) to `vendor_market_schedules`. Backfilled attendance records for existing FT vendor-listing-market combos. Rewrote `get_available_pickup_dates()`: JOINs `listings` for vendor_profile_id, LEFT JOINs `vendor_market_schedules` for attendance + vendor times. FT traditional markets require attendance record. Uses COALESCE(vms.vendor_start_time, ms.start_time) for vendor-specific hours. FM fully backwards-compatible. Applied to Dev, Staging, & Prod. Prod required manual addition of `vendor_market_schedules_vendor_profile_id_schedule_id_key` UNIQUE constraint first (was missing on Prod only). |
| 2026-02-18 | 20260218_030_ft_same_day_ordering | Recreated `get_available_pickup_dates()` with vertical awareness: FT defaults cutoff_hours=0, FT today-only (not 7 days), FT accepts until market end_time (not start-cutoff). Restored `cutoff_hours` to RETURNS TABLE (was dropped in migration 010). Updated existing FT markets with NULL cutoff_hours to 0. Applied to Dev, Staging, & Prod. |
| 2026-02-17 | 20260217_029_add_tip_columns | Added `tip_percentage` (SMALLINT DEFAULT 0) and `tip_amount` (INTEGER DEFAULT 0) to `orders` table. For food truck percentage-based tipping. Applied to Dev, Staging, & Prod. |
| 2026-02-17 | 20260217_028_add_preferred_pickup_time | Added `preferred_pickup_time` (TIME) to `cart_items` and `order_items`. For food truck 30-min pickup time slot selection. Applied to Dev, Staging, & Prod. |
| 2026-02-17 | 20260217_027_expand_vendor_tier_check_constraint | Expanded vendor_profiles tier CHECK to include basic/pro/boss (food truck tiers). Migrated existing food truck vendors to basic. Applied to Dev, Staging, & Prod. |
| 2026-02-17 | 20260217_026_vertical_premium_triggers | Per-vertical buyer premium: `set_listing_premium_window()` and `set_market_box_premium_window()` now check `verticals.config->>'buyer_premium_enabled'` — skip premium window for verticals with it set to `'false'`. Fixed market box trigger capacity-increase regression (removed `NEW.max_subscribers > OLD.max_subscribers` condition). Added `buyer_premium_enabled` to `verticals.config` JSONB: `true` for farmers_market, `false` for food_trucks and fire_works. Cleaned up any existing food truck/fire_works premium windows. Applied to Dev, Staging, & Prod. |
| 2026-02-17 | 20260217_025_rename_fireworks_vertical | Renamed `vertical_id` from `'fireworks'` to `'fire_works'` in `verticals` table and all child tables: `vendor_profiles`, `listings`, `orders`, `market_box_offerings`, `knowledge_articles`, `admin_activity_log`, `error_reports`, `transactions`, `shopper_feedback`, `vendor_feedback`, `vertical_admins`. Also updated `user_profiles.verticals` TEXT[] array. Applied to Dev, Staging, & Prod. |
| 2026-02-17 | 20260217_024_add_quantity_measurement | Added `quantity_amount` (NUMERIC) and `quantity_unit` (TEXT) to `listings` and `market_box_offerings`. CHECK constraint enforces both fields present when `status = 'published'`. Applied to Dev, Staging, & Prod. |
| 2026-02-13 | 20260213_021-023 | Grandfather vendor verifications, add stripe_subscription_id, fix get_or_create_cart vertical type. Applied to Dev, Staging, & Prod. |
| 2026-02-13 | 20260213_017-020 | Audit critical/high fixes: double payout prevention, orphaned fulfillment guard, flat fee proration, Stripe idempotency. Applied to Dev, Staging, & Prod. |
| 2026-02-12 | 20260212_015_add_missing_query_indexes | Added 4 indexes: `order_items(order_id)` FK join index, `orders(buyer_user_id)` buyer lookup, `orders(buyer_user_id, status, created_at DESC)` buyer composite, `transactions(vertical_id, status, created_at DESC)` analytics composite. Applied to Dev & Staging. |
| 2026-02-12 | 20260212_014_food_trucks_vertical | Added `food_trucks` row to `verticals` table with full config JSONB (nouns, seasonality, verification, vendor_fields, listing_fields, buyer_fields, buyer_filters, agreements). Cuisine categories: Mexican, BBQ, Asian, American, Mediterranean, Desserts & Sweets, Coffee & Beverages, Seafood, Fusion, Other. Vendor fields: legal_name, phone, email, business_name, vendor_type (cuisine multi-select), food_handler_permit (file), health_dept_license (file). Applied to Dev & Staging. |
| 2026-02-12 | 20260212_013_knowledge_base | Added `knowledge_articles` table: `id` (UUID PK), `vertical_id` (TEXT FK→verticals.vertical_id), `category` (TEXT NOT NULL), `title` (TEXT NOT NULL), `body` (TEXT NOT NULL), `sort_order` (INT DEFAULT 0), `is_published` (BOOL DEFAULT false), `created_at`, `updated_at`. Index on (is_published, vertical_id, category, sort_order). RLS: public read published, admin full access. Applied to Dev & Staging. |
| 2026-02-12 | 20260123_001_user_notification_preferences | Added to `user_profiles`: `notification_preferences` (JSONB, default email_order_updates=true, others false), `deleted_at` (TIMESTAMPTZ, for soft delete). Index on `deleted_at` WHERE NULL. Applied to Dev & Staging. |
| 2026-02-10 | 20260210_012_vendor_onboarding | Extended `vendor_verifications` for 3-gate onboarding: added `requested_categories` (TEXT[]), `category_verifications` (JSONB), `coi_documents` (JSONB), `coi_status` (TEXT w/ CHECK), `coi_verified_at`, `coi_verified_by` (FK→user_profiles), `prohibited_items_acknowledged_at`, `onboarding_completed_at`. Added 3 RLS policies: `vendor_verifications_insert`, `vendor_verifications_vendor_update`, `vendor_verifications_admin_update`. Added `auto_create_vendor_verification()` trigger on vendor_profiles INSERT. Backfill for existing profiles. Added `can_vendor_publish(UUID, TEXT)` SECURITY DEFINER function. Applied to Dev & Staging. |
| 2026-02-09 | 20260209_009_fix_premium_window_restock_regression | Fixed `set_listing_premium_window()`: removed restock condition that was re-added by 20260201_002, undoing the fix from 20260129_002. Restocking (quantity increase) no longer resets premium_window_ends_at. Cleared any stuck premium windows. Applied to Dev & Staging. |
| 2026-02-09 | 20260209_008_push_subscriptions | Added `push_subscriptions` table: `id` (UUID PK), `user_id` (UUID FK→auth.users ON DELETE CASCADE), `endpoint` (TEXT NOT NULL), `p256dh` (TEXT NOT NULL), `auth` (TEXT NOT NULL), `created_at` (TIMESTAMPTZ). UNIQUE(user_id, endpoint). Index: `idx_push_subscriptions_user_id`. RLS: users SELECT/INSERT/DELETE own rows. Service role bypasses for sendPush(). Applied to Dev & Staging. |
| 2026-02-09 | 20260209_007_vendor_documents_storage | Added `vendor-documents` storage bucket: 10MB limit, allowed MIME types `image/jpeg`, `image/png`, `application/pdf`. Public bucket. 4 RLS policies: authenticated INSERT/UPDATE/DELETE, public SELECT. Files stored as `certifications/{vendorId}/{timestamp}.{ext}`. Applied to Dev & Staging. |
| 2026-02-09 | 20260209_006_vendor_cancellation_tracking | Added 3 columns to `vendor_profiles`: `orders_confirmed_count` (INT NOT NULL DEFAULT 0), `orders_cancelled_after_confirm_count` (INT NOT NULL DEFAULT 0), `cancellation_warning_sent_at` (TIMESTAMPTZ). Added 2 SECURITY DEFINER functions: `increment_vendor_confirmed(UUID)` returns void, `increment_vendor_cancelled(UUID)` returns TABLE(confirmed_count, cancelled_count). Applied to Dev & Staging. |
| 2026-02-09 | 20260209_004_drop_remaining_old_policies | Dropped remaining old-named duplicate policies on 6 tables. transactions: 3 old SELECT/UPDATE. vendor_payouts: 1 old vendor_select. organizations: 1 old admin select. vendor_profiles: merged admin access into select/update, dropped 5 old. vendor_verifications: merged admin access into select, dropped 2 old. verticals: replaced ALL policy with specific admin INSERT/UPDATE/DELETE. Skipped user_profiles (recursion risk). Applied to Dev & Staging. |
| 2026-02-09 | 20260209_003_merge_markets_select_policies | Merged `markets_select` + `markets_public_select` into single comprehensive `markets_select` policy. Includes: approved+active, vendor owns it, buyer order history (via order_items.market_id and listing_markets), platform admin, vertical admin. Applied to Dev & Staging. |
| 2026-02-09 | 20260209_002_merge_duplicate_select_policies | Merged admin+regular SELECT policies into single policy on 6 tables: listings, orders, order_items, transactions, vendor_payouts, notifications. Dropped ~40 old-named policies from previous schema versions. Pure performance optimization — no behavioral change. Applied to Dev & Staging. |
| 2026-02-09 | 20260209_001_add_performance_indexes | Added 10 performance indexes: notifications (user_unread, user_created), order_items (status_expires, vendor_status_created, pickup_date_market), orders (parent_id, vertical_created), market_box_pickups (sub_date_status), market_box_offerings (vendor_active w/ WHERE), market_box_subscriptions (offering_active). Note: 2 indexes had name collisions with existing indexes (IF NOT EXISTS skipped). Applied to Dev & Staging. |
| 2026-02-08 | 20260208_001_market_box_mutual_confirmation | Added 3 columns to `market_box_pickups`: `buyer_confirmed_at` (TIMESTAMPTZ), `vendor_confirmed_at` (TIMESTAMPTZ), `confirmation_window_expires_at` (TIMESTAMPTZ). Enables 30-second mutual confirmation window for market box pickups, matching regular order confirmation flow. Applied to Dev & Staging. |
| 2026-02-06 | 20260206_001_atomic_inventory_decrement | Added `atomic_decrement_inventory(UUID, INTEGER)` function (SECURITY DEFINER). Atomically decrements `listings.quantity` using `GREATEST(0, quantity - p_quantity)` with RETURNING clause. Prevents race condition in concurrent checkouts. Applied to Dev & Staging. |
| 2026-02-06 | (app code) | **Inventory Management**: `listings.quantity` decremented on successful payment in `checkout/success`. New notification types: `inventory_out_of_stock`, `inventory_low_stock` (threshold: 5). No schema changes. |
| 2026-02-06 | (app code) | **Market Box Pricing**: Applied `calculateBuyerPrice()` to market box checkout - now includes 6.5% + $0.15 fee. No schema changes. |
| 2026-02-05 | 20260205_001_pickup_scheduling_schema | Added to cart_items: `schedule_id`, `pickup_date`. Added to order_items: `schedule_id`, `pickup_date`, `pickup_snapshot` (JSONB). Added to orders: `parent_order_id`, `order_suffix`. **NOTE: pickup_start_time/pickup_end_time do NOT exist - use pickup_snapshot.start_time/end_time** |
| 2026-02-05 | 20260205_002_pickup_scheduling_functions | Added functions: `get_available_pickup_dates()`, `validate_cart_item_schedule()`, `build_pickup_snapshot()` |
| 2026-02-05 | 20260205_003_fix_cutoff_threshold | Added `cutoff_hours` to get_available_pickup_dates output |
| 2026-02-04 | 20260204_001_zip_codes_table | Added `zip_codes` table (33k+ US ZIP codes with coordinates); new functions: `get_zip_coordinates()`, `get_nearby_zip_codes()`, `get_region_zip_codes()` |
| 2026-02-03 | 20260203_004_fix_market_box_trigger_column_name | Fixed `set_market_box_premium_window()` trigger: changed `is_active` to `active` (correct column name) |
| 2026-02-03 | 20260203_003_add_vertical_admin_rls_support | Added vertical admin RLS support to 14 tables; new helper functions: `can_admin_market()`, `can_admin_order()`, `can_admin_vendor()` |
| 2026-02-03 | 20260203_002_fix_admin_helper_functions | Fixed `is_platform_admin()` to check both `role` column and `roles` array; added `is_vertical_admin()`, `is_admin_for_vertical()`, `is_any_admin()`, `get_user_admin_verticals()` |
| 2026-02-03 | Initial snapshot | Full schema capture |



---

## Tables (49)

| Table Name |
|------------|
| admin_activity_log |
| audit_log |
| buyer_search_log |
| cart_items |
| carts |
| error_logs |
| error_reports |
| error_resolutions |
| fulfillments |
| knowledge_articles |
| listing_images |
| listing_markets |
| listings |
| market_box_offerings |
| market_box_pickups |
| market_box_subscriptions |
| market_schedules |
| market_vendors |
| markets |
| notifications |
| order_items |
| order_ratings |
| orders |
| organizations |
| payments |
| platform_settings |
| public_activity_events |
| push_subscriptions |
| shopper_feedback |
| spatial_ref_sys |
| transactions |
| user_profiles |
| vendor_activity_flags |
| vendor_activity_scan_log |
| vendor_activity_settings |
| vendor_fee_balance |
| vendor_fee_ledger |
| vendor_feedback |
| vendor_location_cache |
| vendor_market_schedules |
| vendor_payouts |
| vendor_quality_findings |
| vendor_quality_scan_log |
| vendor_profiles |
| vendor_referral_credits |
| vendor_verifications |
| vertical_admins |
| verticals |
| zip_codes |


---

## Columns by Table

### active_markets
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | YES | - |
| vertical_id | text | YES | - |
| vendor_profile_id | uuid | YES | - |
| name | text | YES | - |
| market_type | text | YES | - |
| address | text | YES | - |
| city | text | YES | - |
| state | text | YES | - |
| zip | text | YES | - |
| day_of_week | int4 | YES | - |
| start_time | time | YES | - |
| end_time | time | YES | - |
| status | text | YES | - |
| created_at | timestamptz | YES | - |
| updated_at | timestamptz | YES | - |
| active | bool | YES | - |
| contact_email | text | YES | - |
| submitted_by | uuid | YES | - |
| submitted_at | timestamptz | YES | - |
| reviewed_by | uuid | YES | - |
| reviewed_at | timestamptz | YES | - |
| rejection_reason | text | YES | - |
| latitude | numeric | YES | - |
| longitude | numeric | YES | - |
| geocoding_failed | bool | YES | - |
| contact_phone | text | YES | - |
| timezone | text | YES | - |
| cutoff_hours | int4 | YES | - |
| season_start | date | YES | - |
| season_end | date | YES | - |
| approval_status | market_approval_status | YES | - |
| submitted_by_vendor_id | uuid | YES | - |
| description | text | YES | - |
| website | text | YES | - |
| vendor_sells_at_market | bool | YES | - |
| expires_at | timestamptz | YES | - |

### admin_activity_log
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| action | text | NO | - |
| target_user_id | uuid | NO | - |
| performed_by | uuid | NO | - |
| vertical_id | text | YES | - |
| details | jsonb | YES | - |
| created_at | timestamptz | NO | now() |

### audit_log
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| user_id | uuid | YES | - |
| action | text | NO | - |
| table_name | text | NO | - |
| record_id | uuid | YES | - |
| old_data | jsonb | YES | - |
| new_data | jsonb | YES | - |
| ip_address | inet | YES | - |
| user_agent | text | YES | - |
| created_at | timestamptz | YES | now() |

### buyer_search_log
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | gen_random_uuid() |
| zip_code | text | YES | - |
| vertical_id | text | YES | - |
| results_count | int4 | NO | 0 |
| search_type | text | NO | - |
| created_at | timestamptz | NO | now() |

### cart_items
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | gen_random_uuid() |
| cart_id | uuid | NO | - |
| listing_id | uuid | YES | - |
| quantity | int4 | NO | - |
| created_at | timestamptz | NO | now() |
| updated_at | timestamptz | NO | now() |
| market_id | uuid | YES | - |
| schedule_id | uuid | YES | - |
| pickup_date | date | YES | - |
| item_type | text | NO | 'listing'::text |
| offering_id | uuid | YES | - |
| term_weeks | int4 | YES | - |
| start_date | date | YES | - |
| preferred_pickup_time | time | YES | - |

### carts
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | gen_random_uuid() |
| user_id | uuid | NO | - |
| vertical_id | text | NO | - |
| created_at | timestamptz | NO | now() |
| updated_at | timestamptz | NO | now() |

### error_logs
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | gen_random_uuid() |
| trace_id | text | NO | - |
| error_code | text | NO | - |
| message | text | NO | - |
| context | jsonb | YES | '{}'::jsonb |
| breadcrumbs | jsonb | YES | '[]'::jsonb |
| user_id | uuid | YES | - |
| route | text | YES | - |
| method | text | YES | - |
| pg_code | text | YES | - |
| severity | text | YES | - |
| created_at | timestamptz | NO | now() |

### error_reports
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | gen_random_uuid() |
| error_code | text | YES | - |
| trace_id | text | YES | - |
| vertical_id | text | YES | - |
| page_url | text | YES | - |
| user_agent | text | YES | - |
| reported_by_user_id | uuid | YES | - |
| reporter_email | text | YES | - |
| user_description | text | YES | - |
| status | text | NO | 'pending'::text |
| escalation_level | text | NO | 'vertical_admin'::text |
| assigned_to_user_id | uuid | YES | - |
| resolution_id | uuid | YES | - |
| resolution_notes | text | YES | - |
| vertical_admin_notes | text | YES | - |
| escalated_at | timestamptz | YES | - |
| escalated_by_user_id | uuid | YES | - |
| platform_admin_notes | text | YES | - |
| resolved_at | timestamptz | YES | - |
| resolved_by_user_id | uuid | YES | - |
| created_at | timestamptz | NO | now() |
| updated_at | timestamptz | NO | now() |

### error_resolutions
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | gen_random_uuid() |
| error_code | text | NO | - |
| trace_id | text | YES | - |
| attempted_fix | text | NO | - |
| migration_file | text | YES | - |
| code_changes | text | YES | - |
| status | text | NO | 'pending'::text |
| failure_reason | text | YES | - |
| partial_notes | text | YES | - |
| verification_method | text | YES | - |
| verification_query | text | YES | - |
| verification_result | text | YES | - |
| verified_at | timestamptz | YES | - |
| verified_by | text | YES | - |
| created_at | timestamptz | YES | now() |
| updated_at | timestamptz | YES | now() |
| created_by | text | YES | - |

### fulfillments
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| transaction_id | uuid | NO | - |
| mode | fulfillment_mode | NO | - |
| status | fulfillment_status | YES | 'pending'::fulfillment_status |
| scheduled_at | timestamptz | YES | - |
| confirmed_at | timestamptz | YES | - |
| completed_at | timestamptz | YES | - |
| location_notes | text | YES | - |
| created_at | timestamptz | YES | now() |
| updated_at | timestamptz | YES | now() |

### geography_columns
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| f_table_catalog | name | YES | - |
| f_table_schema | name | YES | - |
| f_table_name | name | YES | - |
| f_geography_column | name | YES | - |
| coord_dimension | int4 | YES | - |
| srid | int4 | YES | - |
| type | text | YES | - |

### geometry_columns
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| f_table_catalog | varchar | YES | - |
| f_table_schema | name | YES | - |
| f_table_name | name | YES | - |
| f_geometry_column | name | YES | - |
| coord_dimension | int4 | YES | - |
| srid | int4 | YES | - |
| type | varchar | YES | - |

### knowledge_articles
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | gen_random_uuid() |
| vertical_id | text | YES | - |
| category | text | NO | - |
| title | text | NO | - |
| body | text | NO | - |
| sort_order | int4 | NO | 0 |
| is_published | bool | NO | false |
| created_at | timestamptz | NO | now() |
| updated_at | timestamptz | NO | now() |

### listing_images
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| listing_id | uuid | NO | - |
| storage_path | text | NO | - |
| url | text | YES | - |
| alt_text | text | YES | - |
| display_order | int4 | YES | 0 |
| is_primary | bool | YES | false |
| created_at | timestamptz | YES | now() |

### listing_markets
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | gen_random_uuid() |
| listing_id | uuid | NO | - |
| market_id | uuid | NO | - |
| available_dates | jsonb | YES | - |
| created_at | timestamptz | NO | now() |

### listings
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| vendor_profile_id | uuid | NO | - |
| vertical_id | text | NO | - |
| status | listing_status | YES | 'draft'::listing_status |
| listing_data | jsonb | YES | '{}'::jsonb |
| address | text | YES | - |
| city | text | YES | - |
| state | text | YES | - |
| zip | text | YES | - |
| latitude | numeric | YES | - |
| longitude | numeric | YES | - |
| available_from | date | YES | - |
| available_to | date | YES | - |
| created_at | timestamptz | YES | now() |
| updated_at | timestamptz | YES | now() |
| deleted_at | timestamptz | YES | - |
| title | text | YES | - |
| description | text | YES | - |
| price_cents | int4 | YES | 0 |
| quantity | int4 | YES | 0 |
| category | text | YES | - |
| image_urls | _text | YES | '{}'::text[] |
| listing_type | listing_type | YES | 'presale'::listing_type |
| premium_window_ends_at | timestamptz | YES | - |
| quantity_amount | numeric | YES | - |
| quantity_unit | text | YES | - |

### market_box_offerings
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| vendor_profile_id | uuid | NO | - |
| vertical_id | text | NO | - |
| name | text | NO | - |
| description | text | YES | - |
| image_urls | _text | YES | '{}'::text[] |
| price_cents | int4 | NO | - |
| pickup_market_id | uuid | NO | - |
| pickup_day_of_week | int4 | NO | - |
| pickup_start_time | time | NO | - |
| pickup_end_time | time | NO | - |
| max_subscribers | int4 | YES | - |
| active | bool | YES | true |
| created_at | timestamptz | YES | now() |
| updated_at | timestamptz | YES | now() |
| price_4week_cents | int4 | NO | - |
| price_8week_cents | int4 | YES | - |
| premium_window_ends_at | timestamptz | YES | - |
| quantity_amount | numeric | YES | - |
| quantity_unit | text | YES | - |
| box_type | text | YES | - |

### market_box_pickups
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| subscription_id | uuid | NO | - |
| week_number | int4 | NO | - |
| scheduled_date | date | NO | - |
| status | market_box_pickup_status | YES | 'scheduled'::market_box_pickup_status |
| ready_at | timestamptz | YES | - |
| picked_up_at | timestamptz | YES | - |
| missed_at | timestamptz | YES | - |
| rescheduled_to | date | YES | - |
| vendor_notes | text | YES | - |
| created_at | timestamptz | YES | now() |
| updated_at | timestamptz | YES | now() |
| is_extension | bool | YES | false |
| skipped_by_vendor_at | timestamptz | YES | - |
| skip_reason | text | YES | - |
| buyer_confirmed_at | timestamptz | YES | - |
| vendor_confirmed_at | timestamptz | YES | - |
| confirmation_window_expires_at | timestamptz | YES | - |

### market_box_subscriptions
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| offering_id | uuid | NO | - |
| buyer_user_id | uuid | NO | - |
| order_id | uuid | YES | - |
| total_paid_cents | int4 | NO | - |
| start_date | date | NO | - |
| status | market_box_subscription_status | YES | 'active'::market_box_subscription_status |
| weeks_completed | int4 | YES | 0 |
| created_at | timestamptz | YES | now() |
| updated_at | timestamptz | YES | now() |
| completed_at | timestamptz | YES | - |
| cancelled_at | timestamptz | YES | - |
| term_weeks | int4 | NO | 4 |
| original_end_date | date | YES | - |
| extended_weeks | int4 | YES | 0 |
| stripe_payment_intent_id | text | YES | - |

### market_schedules
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | gen_random_uuid() |
| market_id | uuid | NO | - |
| day_of_week | int4 | NO | - |
| start_time | time | NO | - |
| end_time | time | NO | - |
| active | bool | YES | true |
| created_at | timestamptz | YES | now() |

### market_vendor_counts
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| market_id | uuid | YES | - |
| vendor_count | int8 | YES | - |

### market_vendors
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | gen_random_uuid() |
| market_id | uuid | NO | - |
| vendor_profile_id | uuid | NO | - |
| approved | bool | YES | false |
| booth_number | text | YES | - |
| notes | text | YES | - |
| created_at | timestamptz | YES | now() |
| updated_at | timestamptz | YES | now() |

### markets
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | gen_random_uuid() |
| vertical_id | text | NO | - |
| vendor_profile_id | uuid | YES | - |
| name | text | NO | - |
| market_type | text | NO | - |
| address | text | YES | - |
| city | text | YES | - |
| state | text | YES | - |
| zip | text | YES | - |
| day_of_week | int4 | YES | - |
| start_time | time | YES | - |
| end_time | time | YES | - |
| status | text | NO | 'active'::text |
| created_at | timestamptz | NO | now() |
| updated_at | timestamptz | NO | now() |
| active | bool | NO | true |
| contact_email | text | YES | - |
| submitted_by | uuid | YES | - |
| submitted_at | timestamptz | YES | - |
| reviewed_by | uuid | YES | - |
| reviewed_at | timestamptz | YES | - |
| rejection_reason | text | YES | - |
| latitude | numeric | YES | - |
| longitude | numeric | YES | - |
| geocoding_failed | bool | YES | false |
| contact_phone | text | YES | - |
| timezone | text | YES | 'America/Chicago'::text |
| cutoff_hours | int4 | YES | 18 |
| season_start | date | YES | - |
| season_end | date | YES | - |
| approval_status | market_approval_status | YES | 'approved'::market_approval_status |
| submitted_by_vendor_id | uuid | YES | - |
| description | text | YES | - |
| website | text | YES | - |
| vendor_sells_at_market | bool | YES | true |
| expires_at | timestamptz | YES | - |
| event_start_date | date | YES | - |
| event_end_date | date | YES | - |
| event_url | text | YES | - |

### notifications
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| user_id | uuid | NO | - |
| type | text | NO | - |
| title | text | NO | - |
| message | text | YES | - |
| data | jsonb | YES | '{}'::jsonb |
| read_at | timestamptz | YES | - |
| created_at | timestamptz | YES | now() |

### order_items
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| order_id | uuid | NO | - |
| listing_id | uuid | NO | - |
| vendor_profile_id | uuid | NO | - |
| quantity | int4 | NO | 1 |
| unit_price_cents | int4 | NO | - |
| subtotal_cents | int4 | NO | - |
| platform_fee_cents | int4 | NO | - |
| vendor_payout_cents | int4 | NO | - |
| status | order_item_status | NO | 'pending'::order_item_status |
| pickup_confirmed_at | timestamptz | YES | - |
| created_at | timestamptz | NO | now() |
| updated_at | timestamptz | NO | now() |
| buyer_confirmed_at | timestamptz | YES | - |
| cancelled_at | timestamptz | YES | - |
| cancelled_by | text | YES | - |
| cancellation_reason | text | YES | - |
| refund_amount_cents | int4 | YES | - |
| pickup_date | date | YES | - |
| market_id | uuid | YES | - |
| expires_at | timestamptz | YES | - |
| vendor_confirmed_at | timestamptz | YES | - |
| confirmation_window_expires_at | timestamptz | YES | - |
| lockdown_active | bool | YES | false |
| lockdown_initiated_at | timestamptz | YES | - |
| issue_reported_at | timestamptz | YES | - |
| issue_reported_by | text | YES | - |
| issue_description | text | YES | - |
| issue_resolved_at | timestamptz | YES | - |
| issue_resolved_by | text | YES | - |
| issue_status | text | YES | 'new'::text |
| issue_admin_notes | text | YES | - |
| schedule_id | uuid | YES | - |
| pickup_snapshot | jsonb | YES | - |
| preferred_pickup_time | time | YES | - |

### order_ratings
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | gen_random_uuid() |
| order_id | uuid | NO | - |
| buyer_user_id | uuid | NO | - |
| vendor_profile_id | uuid | NO | - |
| rating | int4 | NO | - |
| comment | text | YES | - |
| created_at | timestamptz | YES | now() |
| updated_at | timestamptz | YES | now() |

### orders
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| buyer_user_id | uuid | NO | - |
| vertical_id | text | NO | - |
| order_number | text | NO | - |
| status | order_status | NO | 'pending'::order_status |
| subtotal_cents | int4 | NO | - |
| platform_fee_cents | int4 | NO | - |
| total_cents | int4 | NO | - |
| stripe_checkout_session_id | text | YES | - |
| created_at | timestamptz | NO | now() |
| updated_at | timestamptz | NO | now() |
| payment_method | payment_method | YES | 'stripe'::payment_method |
| external_payment_confirmed_at | timestamptz | YES | - |
| external_payment_confirmed_by | uuid | YES | - |
| parent_order_id | uuid | YES | - |
| order_suffix | varchar | YES | - |
| tip_percentage | int2 | YES | 0 |
| tip_amount | int4 | YES | 0 |
| tip_on_platform_fee_cents | int4 | NO | 0 |

### organizations
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| legal_name | text | NO | - |
| dba_name | text | YES | - |
| owner_user_id | uuid | NO | - |
| tax_id | text | YES | - |
| created_at | timestamptz | YES | now() |
| updated_at | timestamptz | YES | now() |
| deleted_at | timestamptz | YES | - |

### payments
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| order_id | uuid | NO | - |
| stripe_payment_intent_id | text | NO | - |
| amount_cents | int4 | NO | - |
| platform_fee_cents | int4 | NO | - |
| status | payment_status | NO | 'pending'::payment_status |
| paid_at | timestamptz | YES | - |
| refunded_at | timestamptz | YES | - |
| refund_amount_cents | int4 | YES | - |
| created_at | timestamptz | YES | now() |
| updated_at | timestamptz | YES | now() |

### platform_settings
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| key | text | NO | - |
| value | text | NO | - |
| description | text | YES | - |
| updated_at | timestamptz | YES | now() |

### public_activity_events
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | gen_random_uuid() |
| vertical_id | text | NO | - |
| event_type | text | NO | - |
| city | text | YES | - |
| item_name | text | YES | - |
| vendor_display_name | text | YES | - |
| item_category | text | YES | - |
| created_at | timestamptz | NO | now() |
| expires_at | timestamptz | NO | (now() + '7 days'::interval) |

### push_subscriptions
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | gen_random_uuid() |
| user_id | uuid | NO | - |
| endpoint | text | NO | - |
| p256dh | text | NO | - |
| auth | text | NO | - |
| created_at | timestamptz | NO | now() |

### shopper_feedback
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | gen_random_uuid() |
| user_id | uuid | NO | - |
| vertical_id | text | NO | - |
| category | shopper_feedback_category | NO | - |
| message | text | NO | - |
| market_name | text | YES | - |
| market_location | text | YES | - |
| market_schedule | text | YES | - |
| status | feedback_status | YES | 'new'::feedback_status |
| admin_notes | text | YES | - |
| resolved_at | timestamptz | YES | - |
| resolved_by | uuid | YES | - |
| created_at | timestamptz | YES | now() |
| updated_at | timestamptz | YES | now() |

### spatial_ref_sys
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| srid | int4 | NO | - |
| auth_name | varchar | YES | - |
| auth_srid | int4 | YES | - |
| srtext | varchar | YES | - |
| proj4text | varchar | YES | - |

### transactions
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| listing_id | uuid | NO | - |
| vendor_profile_id | uuid | NO | - |
| buyer_user_id | uuid | NO | - |
| vertical_id | text | NO | - |
| status | transaction_status | YES | 'initiated'::transaction_status |
| buyer_data | jsonb | YES | '{}'::jsonb |
| notes | text | YES | - |
| created_at | timestamptz | YES | now() |
| updated_at | timestamptz | YES | now() |

### user_profiles
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| user_id | uuid | NO | - |
| email | text | YES | - |
| phone | text | YES | - |
| display_name | text | YES | - |
| roles | _user_role | YES | ARRAY['buyer'::user_role] |
| avatar_url | text | YES | - |
| created_at | timestamptz | YES | now() |
| updated_at | timestamptz | YES | now() |
| deleted_at | timestamptz | YES | - |
| role | user_role | YES | - |
| verticals | _text | YES | '{}'::text[] |
| buyer_tier | text | YES | 'standard'::text |
| buyer_tier_expires_at | timestamptz | YES | - |
| stripe_subscription_id | text | YES | - |
| preferred_latitude | numeric | YES | - |
| preferred_longitude | numeric | YES | - |
| location_source | text | YES | - |
| location_updated_at | timestamptz | YES | - |
| is_chief_platform_admin | bool | YES | false |
| tutorial_completed_at | timestamptz | YES | - |
| tutorial_skipped_at | timestamptz | YES | - |
| vendor_tutorial_completed_at | timestamptz | YES | - |
| vendor_tutorial_skipped_at | timestamptz | YES | - |
| location_text | text | YES | - |
| stripe_customer_id | text | YES | - |
| subscription_status | text | YES | - |
| subscription_cycle | text | YES | - |
| tier_started_at | timestamptz | YES | - |
| tier_expires_at | timestamptz | YES | - |
| notification_preferences | jsonb | YES | '{"sms_marketing": false, "email_marketing": fa... |

### v_error_frequency
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| error_code | text | YES | - |
| report_count | int8 | YES | - |
| affected_verticals | int8 | YES | - |
| last_reported | timestamptz | YES | - |
| first_reported | timestamptz | YES | - |
| resolved_count | int8 | YES | - |
| open_count | int8 | YES | - |

### v_failed_approaches
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| error_code | text | YES | - |
| attempted_fix | text | YES | - |
| migration_file | text | YES | - |
| failure_reason | text | YES | - |
| created_at | timestamptz | YES | - |

### v_platform_admin_escalated_reports
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | YES | - |
| error_code | text | YES | - |
| trace_id | text | YES | - |
| vertical_id | text | YES | - |
| page_url | text | YES | - |
| user_agent | text | YES | - |
| reported_by_user_id | uuid | YES | - |
| reporter_email | text | YES | - |
| user_description | text | YES | - |
| status | text | YES | - |
| escalation_level | text | YES | - |
| assigned_to_user_id | uuid | YES | - |
| resolution_id | uuid | YES | - |
| resolution_notes | text | YES | - |
| vertical_admin_notes | text | YES | - |
| escalated_at | timestamptz | YES | - |
| escalated_by_user_id | uuid | YES | - |
| platform_admin_notes | text | YES | - |
| resolved_at | timestamptz | YES | - |
| resolved_by_user_id | uuid | YES | - |
| created_at | timestamptz | YES | - |
| updated_at | timestamptz | YES | - |
| vertical_name | text | YES | - |
| vertical_slug | text | YES | - |
| error_message | text | YES | - |
| error_context | jsonb | YES | - |
| error_breadcrumbs | jsonb | YES | - |
| resolution_status | text | YES | - |
| resolution_fix | text | YES | - |

### v_verified_solutions
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| error_code | text | YES | - |
| attempted_fix | text | YES | - |
| migration_file | text | YES | - |
| verification_method | text | YES | - |
| verified_at | timestamptz | YES | - |
| verified_by | text | YES | - |

### v_vertical_admin_pending_reports
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | YES | - |
| error_code | text | YES | - |
| trace_id | text | YES | - |
| vertical_id | text | YES | - |
| page_url | text | YES | - |
| user_agent | text | YES | - |
| reported_by_user_id | uuid | YES | - |
| reporter_email | text | YES | - |
| user_description | text | YES | - |
| status | text | YES | - |
| escalation_level | text | YES | - |
| assigned_to_user_id | uuid | YES | - |
| resolution_id | uuid | YES | - |
| resolution_notes | text | YES | - |
| vertical_admin_notes | text | YES | - |
| escalated_at | timestamptz | YES | - |
| escalated_by_user_id | uuid | YES | - |
| platform_admin_notes | text | YES | - |
| resolved_at | timestamptz | YES | - |
| resolved_by_user_id | uuid | YES | - |
| created_at | timestamptz | YES | - |
| updated_at | timestamptz | YES | - |
| vertical_name | text | YES | - |
| vertical_slug | text | YES | - |
| error_message | text | YES | - |
| error_context | jsonb | YES | - |
| error_breadcrumbs | jsonb | YES | - |

### vendor_activity_flags
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| vendor_profile_id | uuid | NO | - |
| vertical_id | text | NO | - |
| reason | vendor_flag_reason | NO | - |
| status | vendor_flag_status | NO | 'pending'::vendor_flag_status |
| details | jsonb | YES | '{}'::jsonb |
| resolved_at | timestamptz | YES | - |
| resolved_by | uuid | YES | - |
| resolution_notes | text | YES | - |
| action_taken | text | YES | - |
| created_at | timestamptz | YES | now() |
| updated_at | timestamptz | YES | now() |

### vendor_activity_scan_log
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| vertical_id | text | YES | - |
| vendors_scanned | int4 | NO | 0 |
| new_flags_created | int4 | NO | 0 |
| flags_auto_resolved | int4 | NO | 0 |
| flags_by_reason | jsonb | YES | '{}'::jsonb |
| started_at | timestamptz | NO | now() |
| completed_at | timestamptz | YES | - |
| duration_ms | int4 | YES | - |
| status | text | NO | 'running'::text |
| error_message | text | YES | - |

### vendor_activity_settings
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| vertical_id | text | NO | - |
| monitoring_enabled | bool | NO | true |
| days_no_login_threshold | int4 | NO | 90 |
| days_no_orders_threshold | int4 | NO | 120 |
| days_no_listing_activity_threshold | int4 | NO | 180 |
| days_incomplete_onboarding_threshold | int4 | NO | 30 |
| check_no_login | bool | NO | true |
| check_no_orders | bool | NO | true |
| check_no_listing_activity | bool | NO | true |
| check_no_published_listings | bool | NO | true |
| check_incomplete_onboarding | bool | NO | true |
| updated_at | timestamptz | YES | now() |
| updated_by | uuid | YES | - |
| created_at | timestamptz | YES | now() |

### vendor_fee_balance
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| vendor_profile_id | uuid | NO | - |
| balance_cents | int4 | NO | 0 |
| oldest_unpaid_at | timestamptz | YES | - |
| last_invoice_at | timestamptz | YES | - |
| created_at | timestamptz | YES | now() |
| updated_at | timestamptz | YES | now() |

### vendor_fee_ledger
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| vendor_profile_id | uuid | NO | - |
| order_id | uuid | YES | - |
| amount_cents | int4 | NO | - |
| type | text | NO | - |
| description | text | YES | - |
| created_at | timestamptz | YES | now() |

### vendor_feedback
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | gen_random_uuid() |
| vendor_profile_id | uuid | NO | - |
| user_id | uuid | NO | - |
| vertical_id | text | NO | - |
| category | vendor_feedback_category | NO | - |
| message | text | NO | - |
| market_name | text | YES | - |
| market_location | text | YES | - |
| market_schedule | text | YES | - |
| status | feedback_status | YES | 'new'::feedback_status |
| admin_notes | text | YES | - |
| resolved_at | timestamptz | YES | - |
| resolved_by | uuid | YES | - |
| created_at | timestamptz | YES | now() |
| updated_at | timestamptz | YES | now() |

### vendor_location_cache
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | gen_random_uuid() |
| vendor_profile_id | uuid | NO | - |
| latitude | numeric | NO | - |
| longitude | numeric | NO | - |
| location_source | text | NO | - |
| source_market_id | uuid | YES | - |
| vertical_id | text | YES | - |
| updated_at | timestamptz | YES | now() |

### vendor_market_schedules
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | gen_random_uuid() |
| vendor_profile_id | uuid | NO | - |
| market_id | uuid | NO | - |
| schedule_id | uuid | NO | - |
| is_active | bool | YES | true |
| created_at | timestamptz | YES | now() |
| updated_at | timestamptz | YES | now() |
| vendor_start_time | time | YES | - |
| vendor_end_time | time | YES | - |

### vendor_payouts
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| order_item_id | uuid | YES | - |
| market_box_pickup_id | uuid | YES | - |
| vendor_profile_id | uuid | NO | - |
| amount_cents | int4 | NO | - |
| stripe_transfer_id | text | YES | - |
| status | payout_status | NO | 'pending'::payout_status |
| transferred_at | timestamptz | YES | - |
| created_at | timestamptz | YES | now() |
| updated_at | timestamptz | YES | now() |

### vendor_quality_findings
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | gen_random_uuid() |
| vendor_profile_id | uuid | NO | - |
| vertical_id | text | NO | - |
| check_type | text | NO | - |
| severity | text | NO | - |
| title | text | NO | - |
| message | text | NO | - |
| details | jsonb | YES | '{}'::jsonb |
| reference_key | text | NO | - |
| status | text | NO | 'active'::text |
| batch_id | uuid | YES | - |
| dismissed_at | timestamptz | YES | - |
| created_at | timestamptz | NO | now() |

### vendor_quality_scan_log
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | gen_random_uuid() |
| started_at | timestamptz | NO | now() |
| completed_at | timestamptz | YES | - |
| vendors_scanned | int4 | NO | 0 |
| findings_created | int4 | NO | 0 |
| findings_by_check | jsonb | YES | '{}'::jsonb |
| status | text | NO | 'running'::text |
| error_message | text | YES | - |
| created_at | timestamptz | NO | now() |

### vendor_profiles
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| user_id | uuid | YES | - |
| organization_id | uuid | YES | - |
| vertical_id | text | NO | - |
| status | vendor_status | YES | 'draft'::vendor_status |
| profile_data | jsonb | YES | '{}'::jsonb |
| created_at | timestamptz | YES | now() |
| updated_at | timestamptz | YES | now() |
| deleted_at | timestamptz | YES | - |
| stripe_account_id | text | YES | - |
| stripe_onboarding_complete | bool | YES | false |
| stripe_charges_enabled | bool | YES | false |
| stripe_payouts_enabled | bool | YES | false |
| tier | text | YES | 'standard'::text |
| profile_image_url | text | YES | - |
| description | text | YES | - |
| social_links | jsonb | YES | '{}'::jsonb |
| home_market_id | uuid | YES | - |
| latitude | numeric | YES | - |
| longitude | numeric | YES | - |
| geocoding_failed | bool | YES | false |
| referral_code | text | YES | - |
| referred_by_vendor_id | uuid | YES | - |
| is_founding_vendor | bool | YES | false |
| founding_vendor_granted_at | timestamptz | YES | - |
| last_active_at | timestamptz | YES | - |
| last_login_at | timestamptz | YES | - |
| first_listing_at | timestamptz | YES | - |
| approved_at | timestamptz | YES | - |
| average_rating | numeric | YES | - |
| rating_count | int4 | YES | 0 |
| subscription_status | text | YES | - |
| subscription_cycle | text | YES | - |
| tier_started_at | timestamptz | YES | - |
| tier_expires_at | timestamptz | YES | - |
| stripe_customer_id | text | YES | - |
| venmo_username | text | YES | - |
| cashapp_cashtag | text | YES | - |
| paypal_username | text | YES | - |
| accepts_cash_at_pickup | bool | YES | false |
| certifications | jsonb | YES | '[]'::jsonb |
| orders_confirmed_count | int4 | NO | 0 |
| orders_cancelled_after_confirm_count | int4 | NO | 0 |
| cancellation_warning_sent_at | timestamptz | YES | - |
| stripe_subscription_id | text | YES | - |

### vendor_referral_credits
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| referrer_vendor_id | uuid | NO | - |
| referred_vendor_id | uuid | NO | - |
| credit_amount_cents | int4 | NO | 1000 |
| status | text | NO | 'pending'::text |
| created_at | timestamptz | YES | now() |
| earned_at | timestamptz | YES | - |
| applied_at | timestamptz | YES | - |
| expires_at | timestamptz | YES | - |
| applied_to | text | YES | - |
| applied_amount_cents | int4 | YES | - |
| voided_reason | text | YES | - |
| voided_at | timestamptz | YES | - |
| voided_by | uuid | YES | - |

### vendor_referral_summary
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| vendor_id | uuid | YES | - |
| referral_code | text | YES | - |
| referred_by_vendor_id | uuid | YES | - |
| pending_count | int8 | YES | - |
| earned_count | int8 | YES | - |
| applied_count | int8 | YES | - |
| available_credits_cents | int8 | YES | - |
| year_earned_cents | int8 | YES | - |
| annual_cap_cents | int4 | YES | - |
| remaining_cap_cents | int8 | YES | - |

### vendor_verifications
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| vendor_profile_id | uuid | NO | - |
| status | verification_status | YES | 'pending'::verification_status |
| submitted_at | timestamptz | YES | - |
| reviewed_at | timestamptz | YES | - |
| reviewed_by | uuid | YES | - |
| notes | text | YES | - |
| documents | jsonb | YES | '[]'::jsonb |
| created_at | timestamptz | YES | now() |
| updated_at | timestamptz | YES | now() |
| requested_categories | _text | YES | '{}'::text[] |
| category_verifications | jsonb | YES | '{}'::jsonb |
| coi_documents | jsonb | YES | '[]'::jsonb |
| coi_status | text | YES | 'not_submitted'::text |
| coi_verified_at | timestamptz | YES | - |
| coi_verified_by | uuid | YES | - |
| prohibited_items_acknowledged_at | timestamptz | YES | - |
| onboarding_completed_at | timestamptz | YES | - |

### vertical_admins
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| user_id | uuid | NO | - |
| vertical_id | text | NO | - |
| is_chief | bool | YES | false |
| granted_by | uuid | YES | - |
| granted_at | timestamptz | YES | now() |

### verticals
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| id | uuid | NO | uuid_generate_v4() |
| vertical_id | text | NO | - |
| name_public | text | NO | - |
| config | jsonb | NO | - |
| is_active | bool | YES | true |
| created_at | timestamptz | YES | now() |
| updated_at | timestamptz | YES | now() |
| buyer_fee_percent | numeric | YES | 6.5 |
| vendor_fee_percent | numeric | YES | 6.5 |

### zip_codes
| Column | Type | Nullable | Default |
|--------|------|----------|--------|
| zip | varchar | NO | - |
| city | varchar | NO | - |
| state | varchar | NO | - |
| state_name | varchar | YES | - |
| county | varchar | YES | - |
| latitude | numeric | NO | - |
| longitude | numeric | NO | - |
| timezone | varchar | YES | - |
| population | int4 | YES | - |
| region_code | varchar | YES | - |
| active_market_area | bool | YES | false |
| created_at | timestamptz | YES | now() |
| updated_at | timestamptz | YES | now() |



---

## Foreign Keys

### admin_activity_log
| Column | References |
|--------|------------|
| vertical_id | verticals.vertical_id |

### audit_log
| Column | References |
|--------|------------|
| user_id | user_profiles.id |

### buyer_search_log
| Column | References |
|--------|------------|
| vertical_id | verticals.vertical_id |

### cart_items
| Column | References |
|--------|------------|
| cart_id | carts.id |
| listing_id | listings.id |
| market_id | markets.id |
| offering_id | market_box_offerings.id |
| schedule_id | market_schedules.id |

### carts
| Column | References |
|--------|------------|
| vertical_id | verticals.vertical_id |

### error_reports
| Column | References |
|--------|------------|
| vertical_id | verticals.vertical_id |
| resolution_id | error_resolutions.id |

### fulfillments
| Column | References |
|--------|------------|
| transaction_id | transactions.id |

### knowledge_articles
| Column | References |
|--------|------------|
| vertical_id | verticals.vertical_id |

### listing_images
| Column | References |
|--------|------------|
| listing_id | listings.id |

### listing_markets
| Column | References |
|--------|------------|
| listing_id | listings.id |
| market_id | markets.id |

### listings
| Column | References |
|--------|------------|
| vendor_profile_id | vendor_profiles.id |
| vertical_id | verticals.vertical_id |

### market_box_offerings
| Column | References |
|--------|------------|
| vendor_profile_id | vendor_profiles.id |
| vertical_id | verticals.vertical_id |
| pickup_market_id | markets.id |

### market_box_pickups
| Column | References |
|--------|------------|
| subscription_id | market_box_subscriptions.id |

### market_box_subscriptions
| Column | References |
|--------|------------|
| offering_id | market_box_offerings.id |
| buyer_user_id | user_profiles.user_id |
| order_id | orders.id |

### market_schedules
| Column | References |
|--------|------------|
| market_id | markets.id |

### market_vendors
| Column | References |
|--------|------------|
| market_id | markets.id |
| vendor_profile_id | vendor_profiles.id |

### markets
| Column | References |
|--------|------------|
| vendor_profile_id | vendor_profiles.id |
| submitted_by | user_profiles.user_id |
| reviewed_by | user_profiles.user_id |
| submitted_by_vendor_id | vendor_profiles.id |

### notifications
| Column | References |
|--------|------------|
| user_id | auth.users.id |

### order_items
| Column | References |
|--------|------------|
| order_id | orders.id |
| listing_id | listings.id |
| vendor_profile_id | vendor_profiles.id |
| market_id | markets.id |
| schedule_id | market_schedules.id |

### order_ratings
| Column | References |
|--------|------------|
| order_id | orders.id |
| vendor_profile_id | vendor_profiles.id |

### orders
| Column | References |
|--------|------------|
| vertical_id | verticals.vertical_id |
| parent_order_id | orders.id |

### organizations
| Column | References |
|--------|------------|
| owner_user_id | user_profiles.id |

### payments
| Column | References |
|--------|------------|
| order_id | orders.id |

### public_activity_events
| Column | References |
|--------|------------|
| vertical_id | verticals.vertical_id |

### shopper_feedback
| Column | References |
|--------|------------|
| vertical_id | verticals.vertical_id |

### transactions
| Column | References |
|--------|------------|
| listing_id | listings.id |
| vendor_profile_id | vendor_profiles.id |
| buyer_user_id | user_profiles.id |
| vertical_id | verticals.vertical_id |

### vendor_activity_flags
| Column | References |
|--------|------------|
| vendor_profile_id | vendor_profiles.id |

### vendor_fee_balance
| Column | References |
|--------|------------|
| vendor_profile_id | vendor_profiles.id |

### vendor_fee_ledger
| Column | References |
|--------|------------|
| vendor_profile_id | vendor_profiles.id |
| order_id | orders.id |

### vendor_feedback
| Column | References |
|--------|------------|
| vendor_profile_id | vendor_profiles.id |
| vertical_id | verticals.vertical_id |

### vendor_location_cache
| Column | References |
|--------|------------|
| vendor_profile_id | vendor_profiles.id |
| source_market_id | markets.id |

### vendor_market_schedules
| Column | References |
|--------|------------|
| vendor_profile_id | vendor_profiles.id |
| market_id | markets.id |
| schedule_id | market_schedules.id |

### vendor_payouts
| Column | References |
|--------|------------|
| order_item_id | order_items.id |
| market_box_pickup_id | market_box_pickups.id |
| vendor_profile_id | vendor_profiles.id |

### vendor_quality_findings
| Column | References |
|--------|------------|
| vendor_profile_id | vendor_profiles.id (ON DELETE CASCADE) |
| vertical_id | verticals.vertical_id |
| batch_id | vendor_quality_scan_log.id |

### vendor_profiles
| Column | References |
|--------|------------|
| organization_id | organizations.id |
| vertical_id | verticals.vertical_id |
| user_id | user_profiles.user_id |
| home_market_id | markets.id |
| referred_by_vendor_id | vendor_profiles.id |

### vendor_referral_credits
| Column | References |
|--------|------------|
| referrer_vendor_id | vendor_profiles.id |
| referred_vendor_id | vendor_profiles.id |

### vendor_verifications
| Column | References |
|--------|------------|
| vendor_profile_id | vendor_profiles.id |
| reviewed_by | user_profiles.id |
| coi_verified_by | user_profiles.id |

### vertical_admins
| Column | References |
|--------|------------|
| vertical_id | verticals.vertical_id |

## Indexes

### admin_activity_log
| Index Name | Definition |
|-----------|------------|
| admin_activity_log_pkey | UNIQUE btree (id) |
| idx_admin_activity_log_target | btree (target_user_id) |
| idx_admin_activity_log_performed_by | btree (performed_by) |
| idx_admin_activity_log_created_at | btree (created_at DESC) |

### audit_log
| Index Name | Definition |
|-----------|------------|
| audit_log_pkey | UNIQUE btree (id) |
| idx_audit_log_user | btree (user_id) |
| idx_audit_log_table | btree (table_name) |
| idx_audit_log_created | btree (created_at) |

### buyer_search_log
| Index Name | Definition |
|-----------|------------|
| buyer_search_log_pkey | UNIQUE btree (id) |
| idx_bsl_vertical_created | btree (vertical_id, created_at DESC) |
| idx_bsl_zip_vertical | btree (zip_code, vertical_id) WHERE zip_code IS NOT NULL |
| idx_bsl_zero_results | btree (vertical_id, created_at DESC) WHERE results_count = 0 |

### cart_items
| Index Name | Definition |
|-----------|------------|
| cart_items_pkey | UNIQUE btree (id) |
| idx_cart_items_cart | btree (cart_id) |
| idx_cart_items_listing | btree (listing_id) |
| idx_cart_items_market | btree (market_id) |
| cart_items_cart_listing_schedule_date_key | UNIQUE btree (cart_id, listing_id, schedule_id, pickup_date) WHERE ((schedule_id IS NOT NULL) AND (pickup_date IS NOT NULL)) |
| cart_items_cart_listing_legacy_key | UNIQUE btree (cart_id, listing_id) WHERE (schedule_id IS NULL) |
| idx_cart_items_schedule | btree (schedule_id) WHERE (schedule_id IS NOT NULL) |
| idx_cart_items_market_box_unique | UNIQUE btree (cart_id, offering_id) WHERE (item_type = 'market_box'::text) |
| idx_cart_items_offering_id | btree (offering_id) WHERE (offering_id IS NOT NULL) |

### carts
| Index Name | Definition |
|-----------|------------|
| carts_pkey | UNIQUE btree (id) |
| idx_carts_user | btree (user_id) |
| idx_carts_vertical | btree (vertical_id) |
| carts_user_id_vertical_id_key | UNIQUE btree (user_id, vertical_id) |

### error_logs
| Index Name | Definition |
|-----------|------------|
| error_logs_pkey | UNIQUE btree (id) |
| idx_error_logs_code | btree (error_code) |
| idx_error_logs_created | btree (created_at DESC) |
| idx_error_logs_user | btree (user_id) |
| idx_error_logs_route | btree (route) |
| idx_error_logs_pg_code | btree (pg_code) |
| idx_error_logs_severity | btree (severity) |

### error_reports
| Index Name | Definition |
|-----------|------------|
| error_reports_pkey | UNIQUE btree (id) |
| idx_error_reports_vertical | btree (vertical_id, status, created_at DESC) |
| idx_error_reports_code | btree (error_code, created_at DESC) |
| idx_error_reports_escalated | btree (escalation_level, status, created_at DESC) WHERE (escalation_level = 'platform_admin'::text) |
| idx_error_reports_pending | btree (status, created_at DESC) WHERE (status = 'pending'::text) |
| idx_error_reports_trace | btree (trace_id) WHERE (trace_id IS NOT NULL) |
| idx_error_reports_resolution | btree (resolution_id) WHERE (resolution_id IS NOT NULL) |

### error_resolutions
| Index Name | Definition |
|-----------|------------|
| error_resolutions_pkey | UNIQUE btree (id) |
| idx_error_resolutions_code | btree (error_code) |
| idx_error_resolutions_verified | btree (error_code, status) WHERE (status = 'verified'::text) |
| idx_error_resolutions_failed | btree (error_code, status) WHERE (status = 'failed'::text) |
| idx_error_resolutions_pending | btree (status, created_at) WHERE (status = 'pending'::text) |
| idx_error_resolutions_trace | btree (trace_id) WHERE (trace_id IS NOT NULL) |

### fulfillments
| Index Name | Definition |
|-----------|------------|
| fulfillments_pkey | UNIQUE btree (id) |
| fulfillments_transaction_id_key | UNIQUE btree (transaction_id) |
| idx_fulfillments_transaction | btree (transaction_id) |
| idx_fulfillments_status | btree (status) |

### knowledge_articles
| Index Name | Definition |
|-----------|------------|
| knowledge_articles_pkey | UNIQUE btree (id) |
| idx_knowledge_articles_published | btree (is_published, vertical_id, category, sort_order) |

### listing_images
| Index Name | Definition |
|-----------|------------|
| listing_images_pkey | UNIQUE btree (id) |
| idx_listing_images_listing_id | btree (listing_id) |
| idx_listing_images_order | btree (listing_id, display_order) |

### listing_markets
| Index Name | Definition |
|-----------|------------|
| listing_markets_pkey | UNIQUE btree (id) |
| listing_markets_listing_id_market_id_key | UNIQUE btree (listing_id, market_id) |
| idx_listing_markets_listing | btree (listing_id) |
| idx_listing_markets_market | btree (market_id) |

### listings
| Index Name | Definition |
|-----------|------------|
| idx_listings_location | btree (latitude, longitude) WHERE (latitude IS NOT NULL) |
| idx_listings_vendor | btree (vendor_profile_id) |
| idx_listings_vertical | btree (vertical_id) |
| idx_listings_status | btree (status) |
| idx_listings_city | btree (city) |
| idx_listings_available | btree (available_from, available_to) |
| listings_pkey | UNIQUE btree (id) |
| idx_listings_data | gin (listing_data) |
| idx_listings_vendor_status | btree (vendor_profile_id, status) WHERE (deleted_at IS NULL) |
| idx_listings_vertical_status | btree (vertical_id, status) WHERE (deleted_at IS NULL) |
| idx_listings_category | btree (vertical_id, category) WHERE (deleted_at IS NULL) |
| idx_listings_vertical_status_created | btree (vertical_id, status, created_at DESC) WHERE (deleted_at IS NULL) |
| idx_listings_vendor_created | btree (vendor_profile_id, created_at DESC) WHERE (deleted_at IS NULL) |
| idx_listings_premium_window | btree (premium_window_ends_at) WHERE (premium_window_ends_at IS NOT NULL) |
| idx_listings_vertical_created | btree (vertical_id, deleted_at, created_at DESC) WHERE (deleted_at IS NULL) |
| idx_listings_quantity_unit | btree (quantity_unit) WHERE (quantity_unit IS NOT NULL) |

### market_box_offerings
| Index Name | Definition |
|-----------|------------|
| market_box_offerings_pkey | UNIQUE btree (id) |
| idx_market_box_offerings_vendor | btree (vendor_profile_id) |
| idx_market_box_offerings_vertical | btree (vertical_id) |
| idx_market_box_offerings_active | btree (active) WHERE (active = true) |
| idx_market_box_offerings_market | btree (pickup_market_id) |
| idx_market_box_premium_window | btree (premium_window_ends_at) WHERE (premium_window_ends_at IS NOT NULL) |
| idx_market_box_offerings_vendor_active | btree (vendor_profile_id, active) |
| idx_market_box_offerings_quantity_unit | btree (quantity_unit) WHERE (quantity_unit IS NOT NULL) |

### market_box_pickups
| Index Name | Definition |
|-----------|------------|
| market_box_pickups_pkey | UNIQUE btree (id) |
| market_box_pickups_subscription_id_week_number_key | UNIQUE btree (subscription_id, week_number) |
| idx_market_box_pickups_sub | btree (subscription_id) |
| idx_market_box_pickups_date | btree (scheduled_date) |
| idx_market_box_pickups_status | btree (status) |
| idx_market_box_pickups_upcoming | btree (scheduled_date, status) WHERE (status = ANY (ARRAY['scheduled'::market_box_pickup_status, 'ready'::market_box_pickup_status])) |
| idx_market_box_pickups_sub_date_status | btree (subscription_id, scheduled_date, status) WHERE (status = ANY (ARRAY['scheduled'::market_box_pickup_status, 'ready'::market_box_pickup_status])) |

### market_box_subscriptions
| Index Name | Definition |
|-----------|------------|
| market_box_subscriptions_pkey | UNIQUE btree (id) |
| idx_market_box_subs_offering | btree (offering_id) |
| idx_market_box_subs_buyer | btree (buyer_user_id) |
| idx_market_box_subs_status | btree (status) |
| idx_market_box_subs_active | btree (offering_id, status) WHERE (status = 'active'::market_box_subscription_status) |
| idx_market_box_subscriptions_offering_status | btree (offering_id, status) |
| idx_market_box_subscriptions_user | btree (buyer_user_id, status) |
| idx_market_box_subscriptions_payment_intent | UNIQUE btree (stripe_payment_intent_id) WHERE (stripe_payment_intent_id IS NOT NULL) |
| idx_market_box_subscriptions_buyer_offering | btree (buyer_user_id, offering_id, status) |
| idx_market_box_subscriptions_offering_active | btree (offering_id, status) WHERE (status = 'active'::market_box_subscription_status) |

### market_schedules
| Index Name | Definition |
|-----------|------------|
| market_schedules_pkey | UNIQUE btree (id) |
| idx_market_schedules_market | btree (market_id) |
| idx_market_schedules_day | btree (day_of_week) |
| idx_market_schedules_market_active | btree (market_id, active) WHERE (active = true) |

### market_vendors
| Index Name | Definition |
|-----------|------------|
| market_vendors_pkey | UNIQUE btree (id) |
| market_vendors_market_id_vendor_profile_id_key | UNIQUE btree (market_id, vendor_profile_id) |
| idx_market_vendors_market | btree (market_id) |
| idx_market_vendors_vendor | btree (vendor_profile_id) |
| idx_market_vendors_market_approved | btree (market_id, approved) |

### markets
| Index Name | Definition |
|-----------|------------|
| markets_pkey | UNIQUE btree (id) |
| idx_markets_vertical | btree (vertical_id) |
| idx_markets_vendor | btree (vendor_profile_id) |
| idx_markets_type | btree (market_type) |
| idx_markets_status | btree (status) |
| idx_markets_active | btree (active) |
| idx_markets_submitted_by | btree (submitted_by) |
| idx_markets_pending | btree (status, vertical_id) WHERE (status = 'pending'::text) |
| idx_markets_coordinates | btree (latitude, longitude) WHERE ((latitude IS NOT NULL) AND (longitude IS NOT NULL)) |
| idx_markets_location | btree (latitude, longitude) WHERE (latitude IS NOT NULL) |
| idx_markets_vertical_status | btree (vertical_id, status) |
| idx_markets_expires_at | btree (expires_at) WHERE (expires_at IS NOT NULL) |
| idx_markets_submitted_by_vendor_id | btree (submitted_by_vendor_id) |
| idx_markets_event_dates | btree (vertical_id, event_start_date, event_end_date) WHERE (market_type = 'event' AND active = true) |

### notifications
| Index Name | Definition |
|-----------|------------|
| notifications_pkey | UNIQUE btree (id) |
| idx_notifications_user | btree (user_id) |
| idx_notifications_unread | btree (user_id) WHERE (read_at IS NULL) |
| idx_notifications_user_unread | btree (user_id, read_at, created_at DESC) WHERE (read_at IS NULL) |
| idx_notifications_user_created | btree (user_id, created_at DESC) |

### order_items
| Index Name | Definition |
|-----------|------------|
| order_items_pkey | UNIQUE btree (id) |
| idx_order_items_order | btree (order_id) |
| idx_order_items_vendor | btree (vendor_profile_id) |
| idx_order_items_listing | btree (listing_id) |
| idx_order_items_status | btree (status) |
| idx_order_items_buyer_confirmed | btree (buyer_confirmed_at) WHERE (buyer_confirmed_at IS NOT NULL) |
| idx_order_items_cancelled | btree (cancelled_at) WHERE (cancelled_at IS NOT NULL) |
| idx_order_items_expires_at | btree (expires_at) WHERE ((expires_at IS NOT NULL) AND (status = 'pending'::order_item_status) AND (cancelled_at IS NULL)) |
| idx_order_items_market | btree (market_id) |
| idx_order_items_unresolved_confirmation | btree (vendor_confirmed_at) WHERE ((buyer_confirmed_at IS NOT NULL) AND (vendor_confirmed_at IS NULL)) |
| idx_order_items_lockdown | btree (lockdown_active) WHERE (lockdown_active = true) |
| idx_order_items_issue_reported | btree (issue_reported_at) WHERE (issue_reported_at IS NOT NULL) |
| idx_order_items_issue_status | btree (issue_status) WHERE (issue_reported_at IS NOT NULL) |
| idx_order_items_vendor_pickup | btree (vendor_profile_id, pickup_date, schedule_id) |
| idx_order_items_schedule | btree (schedule_id) WHERE (schedule_id IS NOT NULL) |
| idx_order_items_status_expires | btree (status, expires_at) WHERE ((status = 'pending'::order_item_status) AND (cancelled_at IS NULL)) |
| idx_order_items_vendor_status_created | btree (vendor_profile_id, status, created_at DESC) WHERE (cancelled_at IS NULL) |
| idx_order_items_pickup_date_market | btree (pickup_date, market_id, status) WHERE ((status <> 'cancelled'::order_item_status) AND (pickup_date IS NOT NULL)) |
| idx_order_items_order_id | btree (order_id) |

### order_ratings
| Index Name | Definition |
|-----------|------------|
| order_ratings_pkey | UNIQUE btree (id) |
| order_ratings_order_id_vendor_profile_id_key | UNIQUE btree (order_id, vendor_profile_id) |
| idx_order_ratings_vendor | btree (vendor_profile_id) |
| idx_order_ratings_buyer | btree (buyer_user_id) |
| idx_order_ratings_order | btree (order_id) |

### orders
| Index Name | Definition |
|-----------|------------|
| orders_pkey | UNIQUE btree (id) |
| orders_order_number_key | UNIQUE btree (order_number) |
| idx_orders_buyer | btree (buyer_user_id) |
| idx_orders_status | btree (status) |
| idx_orders_created | btree (created_at DESC) |
| idx_orders_vertical | btree (vertical_id) |
| idx_orders_buyer_created | btree (buyer_user_id, created_at DESC) |
| idx_orders_payment_method | btree (payment_method) |
| idx_orders_parent | btree (parent_order_id) WHERE (parent_order_id IS NOT NULL) |
| idx_orders_parent_id | btree (parent_order_id) WHERE (parent_order_id IS NOT NULL) |
| idx_orders_vertical_created | btree (vertical_id, created_at DESC) |
| idx_orders_buyer_user_id | btree (buyer_user_id) |
| idx_orders_buyer_status_created | btree (buyer_user_id, status, created_at DESC) |

### organizations
| Index Name | Definition |
|-----------|------------|
| idx_organizations_owner | btree (owner_user_id) |
| organizations_pkey | UNIQUE btree (id) |

### payments
| Index Name | Definition |
|-----------|------------|
| payments_pkey | UNIQUE btree (id) |
| payments_stripe_payment_intent_id_key | UNIQUE btree (stripe_payment_intent_id) |
| idx_payments_order | btree (order_id) |
| idx_payments_stripe | btree (stripe_payment_intent_id) |
| idx_payments_status | btree (status) |

### platform_settings
| Index Name | Definition |
|-----------|------------|
| platform_settings_pkey | UNIQUE btree (key) |

### public_activity_events
| Index Name | Definition |
|-----------|------------|
| public_activity_events_pkey | UNIQUE btree (id) |
| idx_public_activity_recent | btree (vertical_id, created_at DESC) |

### push_subscriptions
| Index Name | Definition |
|-----------|------------|
| push_subscriptions_pkey | UNIQUE btree (id) |
| push_subscriptions_user_id_endpoint_key | UNIQUE btree (user_id, endpoint) |
| idx_push_subscriptions_user_id | btree (user_id) |

### shopper_feedback
| Index Name | Definition |
|-----------|------------|
| shopper_feedback_pkey | UNIQUE btree (id) |
| idx_shopper_feedback_user | btree (user_id) |
| idx_shopper_feedback_vertical | btree (vertical_id) |
| idx_shopper_feedback_category | btree (category) |
| idx_shopper_feedback_status | btree (status) |
| idx_shopper_feedback_created | btree (created_at DESC) |

### spatial_ref_sys
| Index Name | Definition |
|-----------|------------|
| spatial_ref_sys_pkey | UNIQUE btree (srid) |

### transactions
| Index Name | Definition |
|-----------|------------|
| idx_transactions_listing | btree (listing_id) |
| idx_transactions_vendor | btree (vendor_profile_id) |
| idx_transactions_buyer | btree (buyer_user_id) |
| idx_transactions_status | btree (status) |
| transactions_pkey | UNIQUE btree (id) |
| idx_transactions_vendor_created | btree (vendor_profile_id, created_at DESC) |
| idx_transactions_vertical_id | btree (vertical_id) |
| idx_transactions_vertical_status_created | btree (vertical_id, status, created_at DESC) |

### user_profiles
| Index Name | Definition |
|-----------|------------|
| idx_user_profiles_user_id | btree (user_id) |
| idx_user_profiles_email | btree (email) |
| user_profiles_pkey | UNIQUE btree (id) |
| user_profiles_user_id_key | UNIQUE btree (user_id) |
| idx_user_profiles_role | btree (role) |
| idx_user_profiles_verticals | gin (verticals) |
| idx_user_profiles_buyer_tier | btree (buyer_tier) |
| idx_user_profiles_location | btree (preferred_latitude, preferred_longitude) WHERE (preferred_latitude IS NOT NULL) |
| idx_user_profiles_tutorial | btree (user_id) WHERE ((tutorial_completed_at IS NULL) AND (tutorial_skipped_at IS NULL)) |
| idx_user_stripe_customer | btree (stripe_customer_id) WHERE (stripe_customer_id IS NOT NULL) |
| idx_user_buyer_tier | btree (buyer_tier) WHERE (buyer_tier = 'premium'::text) |
| idx_user_subscription_status | btree (subscription_status) WHERE (subscription_status IS NOT NULL) |
| idx_user_profiles_deleted_at | btree (deleted_at) WHERE (deleted_at IS NULL) |

### vendor_activity_flags
| Index Name | Definition |
|-----------|------------|
| vendor_activity_flags_pkey | UNIQUE btree (id) |
| idx_vendor_flags_pending_unique | UNIQUE btree (vendor_profile_id, reason) WHERE (status = 'pending'::vendor_flag_status) |
| idx_vendor_flags_vertical | btree (vertical_id) |
| idx_vendor_flags_status | btree (status) |
| idx_vendor_flags_created | btree (created_at) |
| idx_vendor_flags_vendor | btree (vendor_profile_id) |

### vendor_activity_scan_log
| Index Name | Definition |
|-----------|------------|
| vendor_activity_scan_log_pkey | UNIQUE btree (id) |

### vendor_activity_settings
| Index Name | Definition |
|-----------|------------|
| vendor_activity_settings_pkey | UNIQUE btree (id) |
| vendor_activity_settings_vertical_id_key | UNIQUE btree (vertical_id) |

### vendor_fee_balance
| Index Name | Definition |
|-----------|------------|
| vendor_fee_balance_vendor_profile_id_key | UNIQUE btree (vendor_profile_id) |
| vendor_fee_balance_pkey | UNIQUE btree (id) |
| idx_vendor_fee_balance_vendor | btree (vendor_profile_id) |

### vendor_fee_ledger
| Index Name | Definition |
|-----------|------------|
| vendor_fee_ledger_pkey | UNIQUE btree (id) |
| idx_vendor_fee_ledger_vendor | btree (vendor_profile_id) |
| idx_vendor_fee_ledger_order | btree (order_id) |

### vendor_feedback
| Index Name | Definition |
|-----------|------------|
| vendor_feedback_pkey | UNIQUE btree (id) |
| idx_vendor_feedback_vendor | btree (vendor_profile_id) |
| idx_vendor_feedback_user | btree (user_id) |
| idx_vendor_feedback_vertical | btree (vertical_id) |
| idx_vendor_feedback_category | btree (category) |
| idx_vendor_feedback_status | btree (status) |
| idx_vendor_feedback_created | btree (created_at DESC) |

### vendor_location_cache
| Index Name | Definition |
|-----------|------------|
| vendor_location_cache_pkey | UNIQUE btree (id) |
| idx_vlc_vendor_market_unique | UNIQUE btree (vendor_profile_id, COALESCE(source_market_id, '00000000-0000-0000-0000-000000000000'::uuid) |
| idx_vlc_lat | btree (latitude) |
| idx_vlc_lng | btree (longitude) |
| idx_vlc_coords | btree (latitude, longitude) |
| idx_vlc_vendor | btree (vendor_profile_id) |
| idx_vlc_vertical | btree (vertical_id) |

### vendor_market_schedules
| Index Name | Definition |
|-----------|------------|
| vendor_market_schedules_pkey | UNIQUE btree (id) |
| vendor_market_schedules_vendor_profile_id_schedule_id_key | UNIQUE btree (vendor_profile_id, schedule_id) |
| idx_vms_vendor | btree (vendor_profile_id) |
| idx_vms_market | btree (market_id) |
| idx_vms_schedule | btree (schedule_id) |
| idx_vms_active | btree (is_active) WHERE (is_active = true) |
| idx_vms_vendor_market_active | btree (vendor_profile_id, market_id) WHERE (is_active = true) |

### vendor_payouts
| Index Name | Definition |
|-----------|------------|
| vendor_payouts_pkey | UNIQUE btree (id) |
| vendor_payouts_stripe_transfer_id_key | UNIQUE btree (stripe_transfer_id) |
| idx_payouts_vendor | btree (vendor_profile_id) |
| idx_payouts_order_item | btree (order_item_id) |
| idx_payouts_market_box_pickup | btree (market_box_pickup_id) WHERE market_box_pickup_id IS NOT NULL |
| idx_vendor_payouts_order_item_unique | UNIQUE btree (order_item_id) WHERE status NOT IN ('failed', 'cancelled') |
| idx_payouts_status | btree (status) |

### vendor_quality_findings
| Index Name | Definition |
|-----------|------------|
| vendor_quality_findings_pkey | UNIQUE btree (id) |
| idx_vqf_vendor_active | btree (vendor_profile_id, status) WHERE status = 'active' |
| idx_vqf_vendor_dismissed | btree (vendor_profile_id, check_type, reference_key) WHERE status = 'dismissed' |
| idx_vqf_batch | btree (batch_id) |

### vendor_quality_scan_log
| Index Name | Definition |
|-----------|------------|
| vendor_quality_scan_log_pkey | UNIQUE btree (id) |

### vendor_profiles
| Index Name | Definition |
|-----------|------------|
| idx_vendor_profiles_user | btree (user_id) |
| idx_vendor_profiles_org | btree (organization_id) |
| idx_vendor_profiles_vertical | btree (vertical_id) |
| idx_vendor_profiles_status | btree (status) |
| vendor_profiles_pkey | UNIQUE btree (id) |
| idx_vendor_profiles_data | gin (profile_data) |
| idx_vendor_profiles_email | btree (((profile_data ->> 'email'::text) |
| unique_user_vertical | UNIQUE btree (user_id, vertical_id) |
| idx_vendor_profiles_user_vertical | btree (user_id, vertical_id) |
| idx_vendor_profiles_tier | btree (tier) |
| idx_vendor_profiles_home_market_id | btree (home_market_id) |
| idx_vendor_profiles_coordinates | btree (latitude, longitude) WHERE ((latitude IS NOT NULL) AND (longitude IS NOT NULL)) |
| idx_vendor_profiles_vertical_status | btree (vertical_id, status) |
| vendor_profiles_referral_code_key | UNIQUE btree (referral_code) |
| idx_vendor_profiles_referral_code | btree (referral_code) |
| idx_vendor_profiles_referred_by | btree (referred_by_vendor_id) |
| idx_vendor_profiles_approved_at | btree (approved_at) WHERE (status = 'approved'::vendor_status) |
| idx_vendor_stripe_customer | btree (stripe_customer_id) WHERE (stripe_customer_id IS NOT NULL) |
| idx_vendor_subscription_status | btree (subscription_status) WHERE (subscription_status IS NOT NULL) |
| idx_vendor_profiles_certifications | gin (certifications) |

### vendor_referral_credits
| Index Name | Definition |
|-----------|------------|
| vendor_referral_credits_pkey | UNIQUE btree (id) |
| vendor_referral_credits_referrer_vendor_id_referred_vendor__key | UNIQUE btree (referrer_vendor_id, referred_vendor_id) |
| idx_referral_credits_referrer | btree (referrer_vendor_id) |
| idx_referral_credits_referred | btree (referred_vendor_id) |
| idx_referral_credits_status | btree (status) |
| idx_referral_credits_expires | btree (expires_at) WHERE (status = 'earned'::text) |

### vendor_verifications
| Index Name | Definition |
|-----------|------------|
| idx_vendor_verifications_vendor | btree (vendor_profile_id) |
| idx_vendor_verifications_status | btree (status) |
| vendor_verifications_pkey | UNIQUE btree (id) |

### vertical_admins
| Index Name | Definition |
|-----------|------------|
| vertical_admins_pkey | UNIQUE btree (id) |
| vertical_admins_user_id_vertical_id_key | UNIQUE btree (user_id, vertical_id) |
| idx_vertical_admins_user_id | btree (user_id) |
| idx_vertical_admins_vertical_id | btree (vertical_id) |

### verticals
| Index Name | Definition |
|-----------|------------|
| idx_verticals_vertical_id | btree (vertical_id) |
| idx_verticals_active | btree (is_active) WHERE (is_active = true) |
| verticals_pkey | UNIQUE btree (id) |
| verticals_vertical_id_key | UNIQUE btree (vertical_id) |
| idx_verticals_config_gin | gin (config) |

### zip_codes
| Index Name | Definition |
|-----------|------------|
| zip_codes_pkey | UNIQUE btree (zip) |
| idx_zip_codes_state | btree (state) |
| idx_zip_codes_region | btree (region_code) WHERE (region_code IS NOT NULL) |
| idx_zip_codes_active_market | btree (active_market_area) WHERE (active_market_area = true) |
| idx_zip_codes_city_state | btree (city, state) |
| idx_zip_codes_coords | btree (latitude, longitude) |



---

## Enum Types

| Enum Name | Values |
|-----------|--------|
| feedback_status | new, in_review, resolved, closed |
| fulfillment_mode | pickup, delivery, meetup |
| fulfillment_status | pending, confirmed, completed, failed |
| listing_status | draft, published, paused, archived |
| listing_type | presale, flash, market_box |
| market_approval_status | pending, approved, rejected |
| market_box_pickup_status | scheduled, ready, picked_up, missed, rescheduled, skipped |
| market_box_subscription_status | active, completed, cancelled |
| order_item_status | pending, confirmed, ready, fulfilled, cancelled, refunded |
| order_status | pending, paid, confirmed, ready, completed, cancelled, refunded |
| payment_method | stripe, venmo, cashapp, paypal, cash |
| payment_status | pending, processing, succeeded, failed, cancelled, refunded, partially_refunded |
| payout_status | pending, processing, completed, failed, cancelled |
| shopper_feedback_category | suggest_market, technical_problem, feature_request, vendor_concern, general_feedback |
| transaction_status | initiated, accepted, declined, canceled, fulfilled, expired |
| user_role | buyer, vendor, admin, verifier |
| vendor_feedback_category | suggest_market, technical_problem, feature_request, payment_issue, order_management, listing_help, general_feedback |
| vendor_flag_reason | no_recent_login, no_recent_orders, no_recent_listing_activity, no_published_listings, incomplete_onboarding |
| vendor_flag_status | pending, dismissed, actioned, resolved |
| vendor_status | draft, submitted, approved, rejected, suspended |
| verification_status | pending, in_review, approved, rejected |


---

## Check Constraints

| Table | Constraint | Condition |
|-------|-----------|----------|
| buyer_search_log | buyer_search_log_search_type_check | `(search_type = ANY (ARRAY['markets'::text, 'vendors'::text]))` |
| cart_items | cart_items_item_type_check | `(item_type = ANY (ARRAY['listing'::text, 'market_box'::text]))` |
| cart_items | cart_items_quantity_check | `(quantity > 0)` |
| cart_items | cart_items_term_weeks_check | `((term_weeks IS NULL) OR (term_weeks = ANY (ARRAY[4, 8])))` |
| cart_items | cart_items_type_fields_check | `(((item_type = 'listing'::text) AND (listing_id IS NOT NULL)) OR ((item_type = 'market_box'::text) AND (offering_id I...` |
| error_logs | error_logs_severity_check | `(severity = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'critical'::text]))` |
| error_reports | error_reports_escalation_level_check | `(escalation_level = ANY (ARRAY['vertical_admin'::text, 'platform_admin'::text]))` |
| error_reports | error_reports_status_check | `(status = ANY (ARRAY['pending'::text, 'acknowledged'::text, 'escalated'::text, 'in_progress'::text, 'resolved'::text,...` |
| error_resolutions | error_resolutions_status_check | `(status = ANY (ARRAY['pending'::text, 'verified'::text, 'failed'::text, 'partial'::text]))` |
| listings | listings_quantity_required_for_publish | `((status <> 'published'::listing_status) OR ((quantity_amount IS NOT NULL) AND (quantity_unit IS NOT NULL)))` |
| market_box_offerings | market_box_offerings_pickup_day_of_week_check | `((pickup_day_of_week >= 0) AND (pickup_day_of_week <= 6))` |
| market_box_pickups | market_box_pickups_week_number_check | `((week_number >= 1) AND (week_number <= 16))` |
| market_box_subscriptions | market_box_subscriptions_term_weeks_check | `(term_weeks = ANY (ARRAY[4, 8]))` |
| market_schedules | market_schedules_day_of_week_check | `((day_of_week >= 0) AND (day_of_week <= 6))` |
| markets | markets_day_of_week_check | `((day_of_week >= 0) AND (day_of_week <= 6))` |
| markets | markets_market_type_check | `(market_type = ANY (ARRAY['traditional'::text, 'private_pickup'::text, 'event'::text]))` |
| markets | markets_event_dates_check | `(market_type != 'event' OR (event_start_date IS NOT NULL AND event_end_date IS NOT NULL AND event_end_date >= event_start_date))` |
| markets | markets_status_check | `(status = ANY (ARRAY['pending'::text, 'active'::text, 'inactive'::text, 'rejected'::text, 'suspended'::text]))` |
| markets | valid_market_status | `(status = ANY (ARRAY['pending'::text, 'active'::text, 'inactive'::text, 'rejected'::text]))` |
| order_items | order_items_cancelled_by_check | `(cancelled_by = ANY (ARRAY['buyer'::text, 'vendor'::text, 'system'::text]))` |
| order_items | order_items_issue_status_check | `(issue_status = ANY (ARRAY['new'::text, 'in_review'::text, 'resolved'::text, 'closed'::text]))` |
| order_ratings | order_ratings_rating_check | `((rating >= 1) AND (rating <= 5))` |
| public_activity_events | public_activity_events_event_type_check | `(event_type = ANY (ARRAY['purchase'::text, 'new_vendor'::text, 'sold_out'::text, 'new_listing'::text]))` |
| user_profiles | user_profiles_buyer_tier_check | `(buyer_tier = ANY (ARRAY['standard'::text, 'premium'::text]))` |
| user_profiles | user_profiles_location_source_check | `(location_source = ANY (ARRAY['gps'::text, 'manual'::text, 'ip'::text]))` |
| user_profiles | user_profiles_subscription_cycle_check | `((subscription_cycle = ANY (ARRAY['monthly'::text, 'annual'::text])) OR (subscription_cycle IS NULL))` |
| user_profiles | user_profiles_subscription_status_check | `((subscription_status = ANY (ARRAY['active'::text, 'past_due'::text, 'canceled'::text, 'trialing'::text])) OR (subscr...` |
| vendor_activity_scan_log | vendor_activity_scan_log_status_check | `(status = ANY (ARRAY['running'::text, 'completed'::text, 'failed'::text]))` |
| vendor_quality_findings | vendor_quality_findings_check_type_check | `(check_type = ANY (ARRAY['schedule_conflict'::text, 'low_stock_event'::text, 'price_anomaly'::text, 'ghost_listing'::text, 'inventory_velocity'::text]))` |
| vendor_quality_findings | vendor_quality_findings_severity_check | `(severity = ANY (ARRAY['action_required'::text, 'heads_up'::text, 'suggestion'::text]))` |
| vendor_quality_findings | vendor_quality_findings_status_check | `(status = ANY (ARRAY['active'::text, 'dismissed'::text, 'superseded'::text]))` |
| vendor_quality_scan_log | vendor_quality_scan_log_status_check | `(status = ANY (ARRAY['running'::text, 'completed'::text, 'failed'::text]))` |
| vendor_fee_ledger | vendor_fee_ledger_type_check | `(type = ANY (ARRAY['debit'::text, 'credit'::text]))` |
| vendor_location_cache | vendor_location_cache_location_source_check | `(location_source = ANY (ARRAY['direct'::text, 'market'::text]))` |
| vendor_profiles | vendor_profiles_subscription_cycle_check | `((subscription_cycle = ANY (ARRAY['monthly'::text, 'annual'::text])) OR (subscription_cycle IS NULL))` |
| vendor_profiles | vendor_profiles_subscription_status_check | `((subscription_status = ANY (ARRAY['active'::text, 'past_due'::text, 'canceled'::text, 'trialing'::text])) OR (subscr...` |
| vendor_profiles | vendor_profiles_tier_check | `(tier = ANY (ARRAY['standard'::text, 'premium'::text, 'featured'::text, 'free'::text, 'basic'::text, 'pro'::text, 'boss'::text]))` |
| vendor_referral_credits | vendor_referral_credits_status_check | `(status = ANY (ARRAY['pending'::text, 'earned'::text, 'applied'::text, 'expired'::text, 'voided'::text]))` |
| vendor_verifications | vendor_verifications_coi_status_check | `(coi_status = ANY (ARRAY['not_submitted'::text, 'pending'::text, 'approved'::text, 'rejected'::text]))` |


---

## Functions

| Function | Arguments | Returns | Security |
|----------|-----------|---------|----------|
| atomic_complete_order_if_ready | p_order_id uuid | boolean | DEFINER |
| atomic_decrement_inventory | p_listing_id uuid, p_quantity integer | TABLE(new_quantity integer) | DEFINER |
| auto_add_schedule_to_vendors | - | trigger | DEFINER |
| auto_create_vendor_schedules | - | trigger | DEFINER |
| auto_create_vendor_schedules_insert | - | trigger | DEFINER |
| auto_create_vendor_verification | - | trigger | DEFINER |
| award_referral_credit_on_first_sale | - | trigger | INVOKER |
| box | geometry | box | INVOKER |
| box | box3d | box | INVOKER |
| build_pickup_snapshot | p_schedule_id uuid, p_pickup_date date | jsonb | DEFINER |
| bytea | geometry | bytea | INVOKER |
| bytea | geography | bytea | INVOKER |
| calculate_order_item_expiration | p_pickup_date date, p_buffer_hours integer DEFAULT 18 | timestamp with time zone | DEFINER |
| can_access_pickup | p_subscription_id uuid | boolean | DEFINER |
| can_access_subscription | sub_id uuid | boolean | DEFINER |
| can_admin_market | p_market_id uuid | boolean | DEFINER |
| can_admin_order | p_order_id uuid | boolean | DEFINER |
| can_admin_vendor | p_vendor_profile_id uuid | boolean | DEFINER |
| can_delete_schedule | p_schedule_id uuid | TABLE(can_delete boolean, blocking_order_count integer, b... | DEFINER |
| can_vendor_add_fixed_market | p_vendor_profile_id uuid, p_vertical_id text | boolean | DEFINER |
| can_vendor_add_listing_to_market | p_vendor_profile_id uuid, p_market_id uuid, p_listing_id uuid DEFAULT NULL::uuid | boolean | DEFINER |
| can_vendor_publish | p_vendor_profile_id uuid, p_category text | boolean | DEFINER |
| check_subscription_completion | - | trigger | INVOKER |
| cleanup_cart_items_invalid_schedules | - | TABLE(cart_item_id uuid, user_id uuid, listing_title text... | DEFINER |
| create_market_box_pickups | - | trigger | DEFINER |
| create_profile_for_user | - | trigger | DEFINER |
| equals | geom1 geometry, geom2 geometry | boolean | INVOKER |
| find_srid | character varying, character varying, character varying | integer | INVOKER |
| generate_vendor_referral_code | vendor_id uuid | text | INVOKER |
| geog_brin_inclusion_add_value | internal, internal, internal, internal | boolean | INVOKER |
| geom2d_brin_inclusion_add_value | internal, internal, internal, internal | boolean | INVOKER |
| geom3d_brin_inclusion_add_value | internal, internal, internal, internal | boolean | INVOKER |
| geom4d_brin_inclusion_add_value | internal, internal, internal, internal | boolean | INVOKER |
| geomfromewkb | bytea | geometry | INVOKER |
| geomfromewkt | text | geometry | INVOKER |
| get_analytics_overview | p_start_date date, p_end_date date, p_vertical_id text DEFAULT NULL::text | TABLE(total_revenue bigint, completed_orders bigint, pend... | DEFINER |
| get_available_pickup_dates | p_listing_id uuid | TABLE(market_id uuid, market_name text, market_type text, address text, city text, state text, schedule_id uuid, day_of_week int, pickup_date date, start_time time, end_time time, cutoff_at timestamptz, is_accepting bool, hours_until_cutoff numeric, cutoff_hours int) | DEFINER | JOINs listings for vendor_profile_id, LEFT JOINs vendor_market_schedules for attendance + vendor times. FT traditional/events: requires attendance record. FM: no attendance filter. FT parks: today only, cutoff=0. FT events: 7-day window, advance cutoff (default 24h). FM: 7 days, advance cutoff. Events filtered by event_start_date/event_end_date range + auto-excludes past events (event_end_date >= CURRENT_DATE). |
| get_buyer_order_ids | - | SETOF uuid | DEFINER |
| get_cart_summary | p_cart_id uuid | TABLE(total_items bigint, total_cents bigint, vendor_coun... | DEFINER |
| get_listing_fields | v_id text | jsonb | DEFINER |
| get_listing_market_availability | p_listing_id uuid | jsonb | INVOKER |
| get_listing_markets_summary | p_listing_id uuid | TABLE(market_id uuid, market_name text, market_type text,... | DEFINER |
| get_listing_open_markets | p_listing_id uuid | TABLE(market_id uuid, market_name text, market_type text,... | DEFINER |
| get_market_cutoff | p_market_id uuid | timestamp with time zone | INVOKER |
| get_markets_within_radius | user_lat numeric, user_lng numeric, radius_meters numeric, vertical_filter te... | TABLE(id uuid, name text, description text, address text,... | DEFINER |
| get_nearby_zip_codes | user_lat numeric, user_lng numeric, limit_count integer DEFAULT 5 | TABLE(zip character varying, city character varying, stat... | DEFINER |
| get_next_market_datetime | p_day_of_week integer, p_start_time time without time zone, p_timezone text D... | timestamp with time zone | INVOKER |
| get_or_create_cart | p_user_id uuid, p_vertical_id text | uuid | DEFINER |
| get_proj4_from_srid | integer | text | INVOKER |
| get_region_zip_codes | region character varying | TABLE(zip character varying, city character varying, stat... | DEFINER |
| get_schedule_active_order_count | p_schedule_id uuid | integer | DEFINER |
| get_top_vendors | p_start_date date, p_end_date date, p_vertical_id text DEFAULT NULL::text, p_... | TABLE(vendor_profile_id uuid, total_sales bigint, revenue... | DEFINER |
| get_user_admin_verticals | - | TABLE(vertical_id text, is_platform_admin boolean, is_ver... | DEFINER |
| get_user_vendor_ids | - | SETOF uuid | DEFINER |
| get_vendor_fields | v_id text | jsonb | DEFINER |
| get_vendor_fixed_market_count | p_vendor_profile_id uuid, p_vertical_id text | integer | DEFINER |
| get_vendor_fixed_market_limit | p_vendor_profile_id uuid | integer | DEFINER |
| get_vendor_listing_count_at_market | p_vendor_profile_id uuid, p_market_id uuid | integer | DEFINER |
| get_vendor_next_pickup_date | p_vendor_profile_id uuid, p_market_id uuid, p_from_date date DEFAULT CURRENT_... | date | DEFINER |
| get_vendor_order_ids | - | SETOF uuid | DEFINER |
| get_vendor_revenue_trends | p_vendor_id uuid, p_start_date date, p_end_date date, p_period text | TABLE(period_date date, revenue bigint, orders bigint) | DEFINER |
| get_vendors_within_radius | user_lat numeric, user_lng numeric, radius_meters numeric, vertical_filter te... | TABLE(id uuid, user_id uuid, business_name text, descript... | DEFINER |
| get_vertical_config | v_id text | jsonb | DEFINER |
| get_zip_coordinates | zip_code character varying | TABLE(latitude numeric, longitude numeric, city character... | DEFINER |
| gettransactionid | - | xid | INVOKER |
| gidx_in | cstring | gidx | INVOKER |
| gidx_out | gidx | cstring | INVOKER |
| handle_market_schedule_deactivation | - | trigger | DEFINER |
| handle_new_user | - | trigger | DEFINER |
| has_role | check_role text | boolean | DEFINER |
| has_role | check_role user_role | boolean | DEFINER |
| increment_vendor_cancelled | p_vendor_id uuid | TABLE(confirmed_count integer, cancelled_count integer) | DEFINER |
| increment_vendor_confirmed | p_vendor_id uuid | void | DEFINER |
| is_admin | - | boolean | DEFINER |
| is_admin_for_vertical | p_vertical_id text | boolean | DEFINER |
| is_any_admin | - | boolean | DEFINER |
| is_listing_accepting_orders | p_listing_id uuid | boolean | DEFINER |
| is_order_buyer | order_uuid uuid | boolean | DEFINER |
| is_platform_admin | - | boolean | DEFINER |
| is_verifier | - | boolean | DEFINER |
| is_vertical_admin | p_vertical_id text | boolean | DEFINER |
| json | geometry | json | INVOKER |
| jsonb | geometry | jsonb | INVOKER |
| notify_transaction_status_change | - | trigger | DEFINER |
| overlaps_geog | gidx, geography | boolean | INVOKER |
| overlaps_geog | gidx, gidx | boolean | INVOKER |
| overlaps_geog | geography, gidx | boolean | INVOKER |
| path | geometry | path | INVOKER |
| point | geometry | point | INVOKER |
| polygon | geometry | polygon | INVOKER |
| refresh_all_vendor_locations | - | void | DEFINER |
| refresh_vendor_location | p_vendor_id uuid | void | DEFINER |
| scan_vendor_activity | p_vertical_id text DEFAULT NULL::text | TABLE(scan_id uuid, vendors_scanned integer, new_flags in... | DEFINER | Validates p_vertical_id against verticals table when non-NULL; raises exception for invalid values. NULL = scan all verticals. |
| set_listing_premium_window | - | trigger | DEFINER | Checks `verticals.config->>'buyer_premium_enabled'`; skips premium window if false |
| set_market_box_premium_window | - | trigger | DEFINER | Checks `verticals.config->>'buyer_premium_enabled'`; skips premium window if false |
| set_order_item_expiration | - | trigger | DEFINER |
| soft_delete | - | trigger | INVOKER |
| subscribe_to_market_box_if_capacity | p_offering_id uuid, p_buyer_user_id uuid, p_order_id uuid, p_total_paid_cents... | json | DEFINER |
| sync_verification_status | - | trigger | DEFINER |
| text | geometry | text | INVOKER |
| track_vendor_status_change | - | trigger | DEFINER |
| trg_refresh_vendor_location | - | trigger | DEFINER |
| trigger_cleanup_cart_on_schedule_change | - | trigger | DEFINER |
| trigger_generate_referral_code | - | trigger | INVOKER |
| update_error_reports_updated_at | - | trigger | INVOKER |
| update_error_resolutions_updated_at | - | trigger | INVOKER |
| update_updated_at_column | - | trigger | INVOKER |
| update_vendor_activity_on_listing | - | trigger | DEFINER |
| update_vendor_activity_on_order | - | trigger | DEFINER |
| update_vendor_fee_balance | - | trigger | DEFINER |
| update_vendor_last_login | - | trigger | DEFINER |
| update_vendor_rating_stats | - | trigger | INVOKER |
| user_buyer_order_ids | - | SETOF uuid | DEFINER |
| user_is_subscription_buyer | sub_id uuid | boolean | DEFINER |
| user_is_subscription_vendor | sub_id uuid | boolean | DEFINER |
| user_owns_vendor | vendor_id uuid | boolean | DEFINER |
| user_vendor_order_ids | - | SETOF uuid | DEFINER |
| user_vendor_profile_ids | - | SETOF uuid | DEFINER |
| validate_cart_item_inventory | p_listing_id uuid, p_quantity integer | boolean | DEFINER |
| validate_cart_item_market | p_listing_id uuid, p_market_id uuid | boolean | DEFINER |
| validate_cart_item_schedule | p_listing_id uuid, p_schedule_id uuid, p_pickup_date date | boolean | DEFINER |
| vendor_has_active_schedules | p_vendor_profile_id uuid, p_market_id uuid | boolean | DEFINER |
| vendor_skip_week | p_pickup_id uuid, p_reason text DEFAULT NULL::text | TABLE(skipped_pickup_id uuid, extension_pickup_id uuid, n... | DEFINER |


---

## Triggers

### cart_items
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| set_cart_items_updated_at | UPDATE | BEFORE | update_updated_at_column() |

### carts
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| set_carts_updated_at | UPDATE | BEFORE | update_updated_at_column() |

### error_reports
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| error_reports_updated_at | UPDATE | BEFORE | update_error_reports_updated_at() |

### error_resolutions
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| error_resolutions_updated_at | UPDATE | BEFORE | update_error_resolutions_updated_at() |

### fulfillments
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| update_fulfillments_updated_at | UPDATE | BEFORE | update_updated_at_column() |

### listing_markets
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| trg_vlc_listing_market_change | INSERT | AFTER | trg_refresh_vendor_location() |
| trg_vlc_listing_market_change | DELETE | AFTER | trg_refresh_vendor_location() |

### listings
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| update_listings_updated_at | UPDATE | BEFORE | update_updated_at_column() |
| vendor_activity_listing_trigger | INSERT | AFTER | update_vendor_activity_on_listing() |
| vendor_activity_listing_trigger | UPDATE | AFTER | update_vendor_activity_on_listing() |
| trg_vlc_listing_change | INSERT | AFTER | trg_refresh_vendor_location() |
| trg_vlc_listing_change | DELETE | AFTER | trg_refresh_vendor_location() |
| trg_vlc_listing_change | UPDATE | AFTER | trg_refresh_vendor_location() |
| trigger_listing_premium_window | INSERT | BEFORE | set_listing_premium_window() |
| trigger_listing_premium_window | UPDATE | BEFORE | set_listing_premium_window() |

### market_box_offerings
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| trigger_market_box_premium_window | INSERT | BEFORE | set_market_box_premium_window() |
| trigger_market_box_premium_window | UPDATE | BEFORE | set_market_box_premium_window() |

### market_box_pickups
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| trigger_check_subscription_completion | UPDATE | AFTER | check_subscription_completion() |

### market_box_subscriptions
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| trigger_create_market_box_pickups | INSERT | AFTER | create_market_box_pickups() |

### market_schedules
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| trigger_market_schedule_deactivation | UPDATE | AFTER | handle_market_schedule_deactivation() |
| trigger_auto_add_schedule_to_vendors | INSERT | AFTER | auto_add_schedule_to_vendors() |
| trigger_auto_add_schedule_to_vendors_update | UPDATE | AFTER | auto_add_schedule_to_vendors() |
| trigger_cart_cleanup_on_schedule_change | DELETE | AFTER | trigger_cleanup_cart_on_schedule_change() |
| trigger_cart_cleanup_on_schedule_change | UPDATE | AFTER | trigger_cleanup_cart_on_schedule_change() |

### market_vendors
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| trigger_auto_create_vendor_schedules | UPDATE | AFTER | auto_create_vendor_schedules() |
| trigger_auto_create_vendor_schedules_insert | INSERT | AFTER | auto_create_vendor_schedules_insert() |

### markets
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| set_markets_updated_at | UPDATE | BEFORE | update_updated_at_column() |
| trg_vlc_market_coords_change | UPDATE | AFTER | trg_refresh_vendor_location() |
| trg_vlc_market_status_change | UPDATE | AFTER | trg_refresh_vendor_location() |

### order_items
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| order_items_updated_at | UPDATE | BEFORE | update_updated_at_column() |
| trigger_set_order_item_expiration | INSERT | BEFORE | set_order_item_expiration() |
| trigger_set_order_item_expiration | UPDATE | BEFORE | set_order_item_expiration() |

### order_ratings
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| trigger_update_vendor_rating_stats | INSERT | AFTER | update_vendor_rating_stats() |
| trigger_update_vendor_rating_stats | DELETE | AFTER | update_vendor_rating_stats() |
| trigger_update_vendor_rating_stats | UPDATE | AFTER | update_vendor_rating_stats() |

### orders
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| orders_updated_at | UPDATE | BEFORE | update_updated_at_column() |
| referral_credit_on_sale_trigger | UPDATE | AFTER | award_referral_credit_on_first_sale() |
| vendor_activity_order_trigger | INSERT | AFTER | update_vendor_activity_on_order() |

### organizations
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| update_organizations_updated_at | UPDATE | BEFORE | update_updated_at_column() |

### payments
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| payments_updated_at | UPDATE | BEFORE | update_updated_at_column() |

### shopper_feedback
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| update_shopper_feedback_updated_at | UPDATE | BEFORE | update_updated_at_column() |

### transactions
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| update_transactions_updated_at | UPDATE | BEFORE | update_updated_at_column() |
| notify_transaction_status | UPDATE | AFTER | notify_transaction_status_change() |
| notify_new_transaction | INSERT | AFTER | notify_transaction_status_change() |

### user_profiles
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| update_user_profiles_updated_at | UPDATE | BEFORE | update_updated_at_column() |

### vendor_fee_ledger
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| trigger_update_vendor_fee_balance | INSERT | AFTER | update_vendor_fee_balance() |
| trigger_update_vendor_fee_balance | DELETE | AFTER | update_vendor_fee_balance() |
| trigger_update_vendor_fee_balance | UPDATE | AFTER | update_vendor_fee_balance() |

### vendor_feedback
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| update_vendor_feedback_updated_at | UPDATE | BEFORE | update_updated_at_column() |

### vendor_market_schedules
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| update_vms_updated_at | UPDATE | BEFORE | update_updated_at_column() |

### vendor_payouts
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| vendor_payouts_updated_at | UPDATE | BEFORE | update_updated_at_column() |

### vendor_profiles
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| update_vendor_profiles_updated_at | UPDATE | BEFORE | update_updated_at_column() |
| track_vendor_status | UPDATE | AFTER | track_vendor_status_change() |
| vendor_referral_code_trigger | INSERT | BEFORE | trigger_generate_referral_code() |
| trg_vlc_vendor_change | INSERT | AFTER | trg_refresh_vendor_location() |
| trg_vlc_vendor_change | DELETE | AFTER | trg_refresh_vendor_location() |
| trg_vlc_vendor_change | UPDATE | AFTER | trg_refresh_vendor_location() |
| auto_create_vendor_verification_trigger | INSERT | AFTER | auto_create_vendor_verification() |

### vendor_verifications
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| update_vendor_verifications_updated_at | UPDATE | BEFORE | update_updated_at_column() |
| sync_vendor_verification | UPDATE | AFTER | sync_verification_status() |

### verticals
| Trigger | Event | Timing | Action |
|---------|-------|--------|--------|
| update_verticals_updated_at | UPDATE | BEFORE | update_updated_at_column() |



---

## Views

| View Name | Description |
|-----------|-------------|
| active_markets | Markets with status=active and not expired |
| market_vendor_counts | Count of distinct vendors per market (published listings only) |
| v_error_frequency | Error report counts grouped by error_code |
| v_failed_approaches | Failed error_resolutions ordered by error_code |
| v_platform_admin_escalated_reports | Escalated error reports with joins to verticals, error_logs, error_resolutions |
| v_verified_solutions | Most recent verified error_resolution per error_code |
| v_vertical_admin_pending_reports | Pending/acknowledged vertical admin error reports |
| vendor_referral_summary | Vendor referral stats (pending/earned/applied counts and credits) |
| geography_columns | PostGIS system view |
| geometry_columns | PostGIS system view |

